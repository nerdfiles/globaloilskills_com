<?php
/**
 * 
 * MemberMouse(TM) (http://www.membermouse.com)
 * (c) MemberMouse, LLC. All rights reserved.
 * 
 * MM_Install handles all install/update related tasks. The master schema is located in data/install_sql.php. 
 * Key things to remember when working with the master schema: 
 * 1. The wordpress dbdelta function is used to keep the schema in sync across versions. 
 *    Formatting is very important, please reference the initial schema when adding new tables
 * 2. PRIMARY KEYs need to be declared on a separate line (vs inline with the column definition. Two spaces need to
 *    follow the words PRIMARY KEY and the definition of that key, otherwise the dbdelta will fail
 * 3. FOREIGN KEYs are not currently supported and can potentially cause dbdeltas to fail.
 * 4. Each column or key definition needs to be on its own line. Lines are delimited by \n (unix-style newline)
 * 5. dbdelta() currently doesn't properly deal with backticks surrounding the column name in KEY definitions
 * 6. dbdelta() will add columns to existing tables, but will not drop removed columns. Those operations will need to be done manually 
 * 
 * With a properly formatted schema, the database structure will be synced to the schema on both install and update, eliminating the need for
 * version-specific update code and different code for installs vs updates. Default data with specified keys (either primary keys or unique column values) 
 * is inserted using INSERT IGNORE sql statements. This handles both insert and update scenarios because duplicate key errors are ignored if the data already exists.
 * 
 */
require_once(ABSPATH.'wp-admin/includes/upgrade.php');

 class MM_Install
 {
 	function __construct()
 	{
 		//default constructor
 	}
 	
 	public function activate()
 	{
 		global $wpdb;
 		ob_start();
 		
 		$error = "";
 		
	 	if($this->createDBCache())
	 	{
	 		if($this->updateMemberMouseClass())
	 		{
	 			// reset minor version if this is a major version upgrade
	 			$crntMajorVersion = MM_MemberMouseService::getPluginVersion();
	 			$lastMajorVersion = MM_OptionUtils::getOption(MM_OptionUtils::$OPTION_KEY_MAJOR_VERSION);
	 			if (!empty($lastMajorVersion) && (version_compare($lastMajorVersion, $crntMajorVersion) < 0))
	 			{	
	 				MM_OptionUtils::setOption(MM_OptionUtils::$OPTION_KEY_MINOR_VERSION, MM_MemberMouseService::$DEFAULT_MINOR_VERSION); 
	 			}
	 			
		 		if($this->authenticateWithMM() !== false)
		 		{
		 			if($this->alterMMTables())
		 			{
		 				$this->temporaryRestoreOrderItemAccessPatch();
		 				$this->temporaryPendingOverdueSubscriptionPatch();
		 				$this->populateOriginAffiliateIds();
		 				if($this->insertMMDefaultData())
		 				{	 							
		 					// set new major version
		 					$crntMajorVersion = MM_MemberMouseService::getPluginVersion();
		 					MM_OptionUtils::setOption(MM_OptionUtils::$OPTION_KEY_MAJOR_VERSION, $crntMajorVersion);
		 					
		 					//update version history
		 					$versionDescription = $crntMajorVersion;
		 					$minorVersion = MM_OptionUtils::getOption(MM_OptionUtils::$OPTION_KEY_MINOR_VERSION);
		 					
		 					if($minorVersion !== false && intval($minorVersion) > 0)
		 					{
		 						$versionDescription .= "-".$minorVersion;
		 					}
		 					else
		 					{
		 						$versionDescription .= "-".MM_MemberMouseService::$DEFAULT_MINOR_VERSION;
		 					}
		 					
 							$versionRelease = MM_VersionRelease::findByVersion($versionDescription);
 							$versionRelease->setVersion($versionDescription);
 							$versionRelease->commitData();
 							
 							MM_MemberMouseService::activatePlugin();
 							
 							// clear major version notice
 							$crntMajorVersion = MM_MemberMouseService::getPluginVersion();
 							$upgradeVersion = MM_OptionUtils::setOption(MM_OptionUtils::$OPTION_KEY_UPGRADE_NOTICE);
 							if(!empty($upgradeVersion) && (version_compare($crntMajorVersion, $upgradeVersion, ">=")))
 							{
 								MM_OptionUtils::setOption(MM_OptionUtils::$OPTION_KEY_UPGRADE_NOTICE, "");
 							}
 							
 							ob_end_clean();
	 						return true;	
		 				}
				 		else 
				 		{
	 						$error = "Could not install default data.";
				 		}
		 			}
			 		else 
			 		{
	 					$error = "Could not alter MemberMouse tables.";
			 		}
		 		}
		 		else 
		 		{
		 			$error = "<div style='font-family: sans-serif; font-size: 13px;'>";
		 			
		 			$error .= "<h3 style='color:#BC0B0B; margin-top:0px; margin-bottom:5px; font-size: 14px;'>This site is not authorized to use the MemberMouse plugin</h3>";
		 			
		 			$error .= "<p style='margin-top:0px; margin-bottom:5px;'>In order to use the MemberMouse plugin you need to <a href=\"https://membermouse.uservoice.com/knowledgebase/articles/319186-installing-membermouse\" target=\_blank\">register your site with membermouse.com</a>.</p>";
		 			
		 			$error .= "</div>";
		 		}
	 		}
	 		else 
	 		{
	 			$error = "Could not insert MM_MemberMouseService into DB cache";
	 		}
	 		
		}
		else 
		{
			$error = "Could not create DB cache";
		}
 		
	 	ob_end_clean();
	 	
 		// an error occurred so deactivate the plugin
		$this->showError($error);
		exit;
 	}
 	
 	
 	private function showError($error)
 	{
		$vars = new stdClass();
		$vars->content = $error;
		echo $error; 
		@deactivate_plugins(MM_PLUGIN_ABSPATH."/index.php", false);
 	}
 	
 	
 	private function createDBCache()
 	{
 		global $wpdb;
 		
 		require_once(MM_PLUGIN_ABSPATH."/data/db_cache_sql.php");
 	
		if(isset($sql) && count($sql) > 0)
		{
			foreach($sql as $query)
			{
				try
				{
					$result = $wpdb->query($query);
					if(!$result) 
					{
						return false;
					}
				}
				catch(Exception $e)
				{
					return false;
				}
			}
			
			$countSql = "select count(*) as total from ".MM_TABLE_CONTAINER." where name='membermouseservice'";
			$row = $wpdb->get_row($countSql);
			
			if($row===false)
			{
				return false;
			}	
		}
		
		return true;
 	}
 	
 	public function updateMemberMouseClass()
 	{
 		global $wpdb;
 		
 		$removeSql = "DELETE FROM ".MM_TABLE_CONTAINER." WHERE name='membermouseservice'";
		$row = $wpdb->get_row($removeSql);
		$wpdb->query($removeSql);
		
		$addSql = "INSERT INTO ".MM_TABLE_CONTAINER." (name, obj, is_system, date_added) values ('membermouseservice', 'Ci8qKgogKiAKICogTWVtYmVyTW91c2UoVE0pIChodHRwOi8vd3d3Lm1lbWJlcm1vdXNlLmNvbSkKICogKGMpIE1lbWJlck1vdXNlLCBMTEMuIEFsbCByaWdodHMgcmVzZXJ2ZWQuCiAqLwpjbGFzcyBNTV9NZW1iZXJNb3VzZVNlcnZpY2UKewoJcHVibGljIHN0YXRpYyAkU0VSVkVSSVAgPSBNTV9DRU5UUkFMX1NFUlZFUjsgCgkKCXByaXZhdGUgc3RhdGljICRDSEVDS0lOX0lOVEVSVkFMID0gMjsKCXB1YmxpYyBzdGF0aWMgJERFRkFVTFRfTUlOT1JfVkVSU0lPTiA9ICIxMDAiOwoJCglwdWJsaWMgc3RhdGljICRVU0FHRV9QQUlEX01FTUJFUlMgPSAidXNhZ2VfcGFpZF9tZW1iZXJzIjsNCglwdWJsaWMgc3RhdGljICRVU0FHRV9GUkVFX01FTUJFUlMgPSAidXNhZ2VfZnJlZV9tZW1iZXJzIjsKCXB1YmxpYyBzdGF0aWMgJFVTQUdFX1BBSURfQlVORExFUyA9ICJ1c2FnZV9wYWlkX2J1bmRsZXMiOwoJcHVibGljIHN0YXRpYyAkVVNBR0VfRlJFRV9CVU5ETEVTID0gInVzYWdlX2ZyZWVfYnVuZGxlcyI7CglwdWJsaWMgc3RhdGljICRVU0FHRV9PUkRFUlMgPSAidXNhZ2Vfb3JkZXJzIjsKCXB1YmxpYyBzdGF0aWMgJENPTkZJR19QQVlNRU5UX01FVEhPRFMgPSAiY29uZmlnX3BheW1lbnRfbWV0aG9kcyI7CglwdWJsaWMgc3RhdGljICRDT05GSUdfTUVNQkVSU0hJUFNfRlJFRSA9ICJjb25maWdfZnJlZV9tZW1iZXJzaGlwcyI7CglwdWJsaWMgc3RhdGljICRDT05GSUdfTUVNQkVSU0hJUFNfUEFJRCA9ICJjb25maWdfcGFpZF9tZW1iZXJzaGlwcyI7CglwdWJsaWMgc3RhdGljICRDT05GSUdfQlVORExFU19GUkVFID0gImNvbmZpZ19mcmVlX2J1bmRsZXMiOwoJcHVibGljIHN0YXRpYyAkQ09ORklHX0JVTkRMRVNfUEFJRCA9ICJjb25maWdfcGFpZF9idW5kbGVzIjsKCXB1YmxpYyBzdGF0aWMgJENPTkZJR19QUk9EVUNUUyA9ICJjb25maWdfcHJvZHVjdHMiOwoJcHVibGljIHN0YXRpYyAkQ09ORklHX0RFRkFVTFRfRU1QTE9ZRUVfRU1BSUwgPSAiY29uZmlnX2RmbHRfZW1wbG95ZWVfZW1haWwiOwoJcHVibGljIHN0YXRpYyAkQ09ORklHX0RFRkFVTFRfRU1QTE9ZRUVfTkFNRSA9ICJjb25maWdfZGZsdF9lbXBsb3llZV9uYW1lIjsKCXB1YmxpYyBzdGF0aWMgJENPTkZJR19DVVJSRU5DWSA9ICJjb25maWdfY3VycmVuY3kiOw0KCQ0KCXB1YmxpYyBzdGF0aWMgJFBST1BTX1dQX1ZFUlNJT04gPSAid3BfdmVyc2lvbiI7DQoJcHVibGljIHN0YXRpYyAkUFJPUFNfUEhQX1ZFUlNJT04gPSAicGhwX3ZlcnNpb24iOwoJDQoJcHVibGljIHN0YXRpYyAkTUVUSE9EX0FVVEhPUklaRSA9ICJhdXRob3JpemVQbHVnaW4iOwoJcHVibGljIHN0YXRpYyAkTUVUSE9EX0FDVElWQVRFID0gImFjdGl2YXRlUGx1Z2luIjsNCglwdWJsaWMgc3RhdGljICRNRVRIT0RfREVBQ1RJVkFURSA9ICJkZWFjdGl2YXRlUGx1Z2luIjsKCQoJDQoJDQoJLyoqDQoJICogRGV0ZXJtaW5lcyBpZiB0aGUgcGx1Z2luIHNob3VsZCBhdXRob3JpemUgd2l0aCBNTSBjZW50cmFsDQoJICovDQoJcHJpdmF0ZSBzdGF0aWMgZnVuY3Rpb24gZG9BdXRob3JpemUoKQ0KCXsNCgkJaWYoIXByZWdfbWF0Y2goIi8ocGx1Z2luc1wucGhwKS8iLCAkX1NFUlZFUlsiUEhQX1NFTEYiXSkpDQoJCXsNCgkJCSRsYXN0Q2hlY2tpbiA9IGJhc2U2NF9kZWNvZGUoTU1fT3B0aW9uVXRpbHM6OmdldE9wdGlvbihNTV9PcHRpb25VdGlsczo6JE9QVElPTl9LRVlfTEFTVF9DSEVDS0lOKSk7DQoJCQkkbmV4dENoZWNrID0gc3RydG90aW1lKCIrIi5zZWxmOjokQ0hFQ0tJTl9JTlRFUlZBTC4iIGRheSIsIHN0cnRvdGltZSgkbGFzdENoZWNraW4pKTsNCgkJCSR0b2RheSA9IGRhdGUoIlktbS1kIGg6aTpzIik7DQoJDQoJCQlpZihzdHJ0b3RpbWUoJHRvZGF5KSA+PSAkbmV4dENoZWNrKQ0KCQkJew0KCQkJCXJldHVybiB0cnVlOw0KCQkJfQ0KCQkJCQ0KCQkJcmV0dXJuIGZhbHNlOw0KCQl9DQoJDQoJCXJldHVybiBmYWxzZTsNCgl9CgkNCglwdWJsaWMgc3RhdGljIGZ1bmN0aW9uIGF1dGhvcml6ZSgkcmVmcmVzaENsYXNzZXM9dHJ1ZSkNCgl7CgkJJHVybCA9IE1NX09wdGlvblV0aWxzOjpnZXRPcHRpb24oInNpdGV1cmwiKTsNCgkJJHZlcnNpb24gPSBNTV9NZW1iZXJNb3VzZVNlcnZpY2U6OmdldFBsdWdpblZlcnNpb24oKTsNCgkJJHBvc3R2YXJzID0gInVybD0iLnVybGVuY29kZSgkdXJsKS4iJnZlcnNpb249Ii4kdmVyc2lvbjsNCgkJJG1pbm9yVmVyc2lvbiA9IE1NX09wdGlvblV0aWxzOjpnZXRPcHRpb24oTU1fT3B0aW9uVXRpbHM6OiRPUFRJT05fS0VZX01JTk9SX1ZFUlNJT04pOw0KDQoJCWlmKCRtaW5vclZlcnNpb24gIT09IGZhbHNlICYmIGludHZhbCgkbWlub3JWZXJzaW9uKSA+IDApDQoJCXsNCgkJCSRwb3N0dmFycyAuPSAiJm1pbm9yX3ZlcnNpb249Ii4kbWlub3JWZXJzaW9uOw0KCQl9CgkJZWxzZSAKCQl7CgkJCSRwb3N0dmFycyAuPSAiJm1pbm9yX3ZlcnNpb249Ii5zZWxmOjokREVGQVVMVF9NSU5PUl9WRVJTSU9OOwoJCX0KCQkKCQlpZihjbGFzc19leGlzdHMoIk1NX0FwcGxpZWRCdW5kbGUiKSkNCgkJewoJCQkkcG9zdHZhcnMgLj0gIiZzdGF0aXN0aWNzPSIudXJsZW5jb2RlKGpzb25fZW5jb2RlKE1NX01lbWJlck1vdXNlU2VydmljZTo6Z2VuZXJhdGVTdGF0aXN0aWNzKCkpKTsNCgkJfQoJCQ0KCQkkcG9zdHZhcnMgLj0gIiZwcm9wZXJ0aWVzPSIudXJsZW5jb2RlKGpzb25fZW5jb2RlKE1NX01lbWJlck1vdXNlU2VydmljZTo6Z2VuZXJhdGVQcm9wZXJ0aWVzKCkpKTsKCQkKCQkkcG9zdHZhcnMgLj0gIiZnZXRfY2xhc3Nlcz0iLigkcmVmcmVzaENsYXNzZXMgPyAiMSIgOiAiMCIpOwoJCQ0KCQkkanNvbl9kYXRhID0gc2VsZjo6c2VuZFJlcXVlc3Qoc2VsZjo6JE1FVEhPRF9BVVRIT1JJWkUsICRwb3N0dmFycyk7CgkJCgkJaWYoJGpzb25fZGF0YSA9PT0gZmFsc2UpCgkJewoJCQkvLyBpc3N1ZSBhdXRob3JpemluZyB3aXRoIGNlbnRyYWwgc2VydmVyCgkJCU1NX09wdGlvblV0aWxzOjpzZXRPcHRpb24oTU1fT3B0aW9uVXRpbHM6OiRPUFRJT05fS0VZX0xBU1RfQ0hFQ0tJTiwgYmFzZTY0X2VuY29kZShkYXRlKCJZLW0tZCBoOmk6cyIpKSk7CgkJCXJldHVybiB0cnVlOwoJCX0NCgkJZWxzZSBpZighc2VsZjo6aXNTdWNjZXNzZnVsUmVzdWx0KCRqc29uX2RhdGEpKQ0KCQl7CgkJCWlmKE1NX1V0aWxzOjppc01lbWJlck1vdXNlQWN0aXZlKCkpCgkJCXsKCQkJCXNlbGY6OmluaXRpYXRlUGx1Z2luRGVhY3RpdmF0aW9uKCk7CgkJCX0KCQkJDQoJCQlyZXR1cm4gZmFsc2U7DQoJCX0NCgkNCgkJJGpzb24gPSAkanNvbl9kYXRhLT5yZXNwb25zZV9kYXRhOw0KCQlyZXR1cm4gc2VsZjo6dXBkYXRlTGljZW5zZURhdGEoJGpzb24pOw0KCX0KCQoJcHVibGljIHN0YXRpYyBmdW5jdGlvbiBhY3RpdmF0ZVBsdWdpbigpDQoJew0KCQkkcG9zdHZhcnMgPSAidXJsPSIuTU1fT3B0aW9uVXRpbHM6OmdldE9wdGlvbigic2l0ZXVybCIpOw0KCQlzZWxmOjpzZW5kUmVxdWVzdChzZWxmOjokTUVUSE9EX0FDVElWQVRFLCAkcG9zdHZhcnMpOw0KCX0KCQoJcHVibGljIHN0YXRpYyBmdW5jdGlvbiBkZWFjdGl2YXRlUGx1Z2luKCkKCXsKCQkvLyBjbGVhciBsaWNlbnNlIGRhdGENCgkJTU1fT3B0aW9uVXRpbHM6OnNldE9wdGlvbihNTV9PcHRpb25VdGlsczo6JE9QVElPTl9LRVlfTElDRU5TRV9EQVRBLCAiIik7CgkJTU1fT3B0aW9uVXRpbHM6OnNldE9wdGlvbihNTV9PcHRpb25VdGlsczo6JE9QVElPTl9LRVlfTEFTVF9DSEVDS0lOLCAiIik7CgkJCgkJJHBvc3R2YXJzID0gInVybD0iLk1NX09wdGlvblV0aWxzOjpnZXRPcHRpb24oInNpdGV1cmwiKTsKCQlzZWxmOjpzZW5kUmVxdWVzdChzZWxmOjokTUVUSE9EX0RFQUNUSVZBVEUsICRwb3N0dmFycyk7Cgl9CgkKCS8qKgoJICogVGhpcyBmdW5jdGlvbiBmb3JjZXMgYSBjaGVja2luCgkgKi8KCXB1YmxpYyBzdGF0aWMgZnVuY3Rpb24gcGluZygpCgl7CgkJLy8gY2hlY2sgaWYgTWVtYmVyTW91c2UgcGx1Z2luIGlzIGFjdGl2ZQ0KCQlpZighTU1fVXRpbHM6OmlzTWVtYmVyTW91c2VBY3RpdmUoKSkNCgkJew0KCQkJcmV0dXJuIG5ldyBNTV9SZXNwb25zZSgiTWVtYmVyTW91c2UgcGx1Z2luIGlzIGN1cnJlbnRseSBkZWFjdGl2YXRlZCIsIE1NX1Jlc3BvbnNlOjokRVJST1IpOw0KCQl9CgkJCgkJcmV0dXJuIHNlbGY6OmF1dGhvcml6ZShmYWxzZSk7Cgl9DQoJDQoJcHJpdmF0ZSBzdGF0aWMgZnVuY3Rpb24gdXBkYXRlTGljZW5zZURhdGEoJGpzb24pDQoJew0KCQlpZihpc3NldCgkanNvbi0+aXNWYWxpZCkpDQoJCXsKCQkJaWYoaXNzZXQoJGpzb24tPmxpY2Vuc2VEYXRhKSkKCQkJewoJCQkJJGxpY2Vuc2UgPSBuZXcgTU1fTGljZW5zZSgiIiwgZmFsc2UpOwoJCQkJJGxpY2Vuc2UtPnNldERhdGEoJGpzb24tPmxpY2Vuc2VEYXRhKTsKCQkJCU1NX09wdGlvblV0aWxzOjpzZXRPcHRpb24oTU1fT3B0aW9uVXRpbHM6OiRPUFRJT05fS0VZX0xBU1RfQ0hFQ0tJTiwgYmFzZTY0X2VuY29kZShkYXRlKCJZLW0tZCBoOmk6cyIpKSk7CgkJCQlNTV9NZW1iZXJNb3VzZVNlcnZpY2U6OnN0b3JlTGljZW5zZSgkbGljZW5zZSk7CgkJCX0KCQkJDQoJCQlpZighZW1wdHkoJGpzb24tPmNsYXNzZXMpKQoJCQl7CQ0KCQkJCXNlbGY6OnNhdmVEeW5hbWljQ2xhc3NlcygkanNvbi0+Y2xhc3Nlcyk7CgkJCX0KCQkJCgkJCWlmKCFlbXB0eSgkanNvbi0+bm90aWZpY2F0aW9ucykgJiYgaXNfYXJyYXkoJGpzb24tPm5vdGlmaWNhdGlvbnMpKQ0KCQkJewoJCQkJZm9yZWFjaCgkanNvbi0+bm90aWZpY2F0aW9ucyBhcyAkbm90aWZpY2F0aW9uKQoJCQkJewoJCQkJCXN3aXRjaCgkbm90aWZpY2F0aW9uLT50eXBlKQ0KCQkJCQl7DQoJCQkJCQljYXNlICJtYWpvci12ZXJzaW9uLXVwZ3JhZGUiOg0KCQkJCQkJCU1NX09wdGlvblV0aWxzOjpzZXRPcHRpb24oTU1fT3B0aW9uVXRpbHM6OiRPUFRJT05fS0VZX1VQR1JBREVfTk9USUNFLCAkbm90aWZpY2F0aW9uLT52YWx1ZSk7DQoJCQkJCQkJYnJlYWs7CgkJCQkJCQkKCQkJCQkJY2FzZSAibWlub3ItdmVyc2lvbi11cGdyYWRlIjoKICAgICAgICAJCQkJCU1NX09wdGlvblV0aWxzOjpzZXRPcHRpb24oTU1fT3B0aW9uVXRpbHM6OiRPUFRJT05fS0VZX01JTk9SX1ZFUlNJT04sICRub3RpZmljYXRpb24tPnZhbHVlKTsNCgkJCQkJCQlicmVhazsNCgkJCQkJfQoJCQkJfQ0KCQkJfQ0KCQ0KCQkJcmV0dXJuIHRydWU7DQoJCX0NCgkNCgkJcmV0dXJuIGZhbHNlOw0KCX0KCQoJCgkvKiogVVRJTElUSUVTICoqLwoJCglwcml2YXRlIHN0YXRpYyBmdW5jdGlvbiBzYXZlRHluYW1pY0NsYXNzZXMoJGNsYXNzZXMpCgl7CgkJZ2xvYmFsICR3cGRiOwoJCQoJCWlmKGlzX29iamVjdCgkY2xhc3NlcykgfHwgaXNfYXJyYXkoJGNsYXNzZXMpKQoJCXsKCQkJJHNxbCA9ICJERUxFVEUgRlJPTSAiLk1NX1RBQkxFX0NPTlRBSU5FUi4iIFdIRVJFIGlzX3N5c3RlbT0nMCciOwoJCQkkd3BkYi0+cXVlcnkoJHNxbCk7CgkJCQoJCQlmb3JlYWNoKCRjbGFzc2VzIGFzICRjbGFzc05hbWU9PiRjbGFzc0VudHJ5KQoJCQl7CgkJCQkkc3FsID0gIklOU0VSVCBJTlRPICIuTU1fVEFCTEVfQ09OVEFJTkVSLiIgU0VUIG5hbWU9JyVzJywgb2JqPSclcycsIGRhdGVfYWRkZWQ9Tk9XKCkiOwoJCQkJCgkJCQlpZihzdHJ0b2xvd2VyKCRjbGFzc05hbWUpID09ICJtZW1iZXJtb3VzZXNlcnZpY2UiKQoJCQkJewoJCQkJCSRzcWwgPSAiVVBEQVRFICIuTU1fVEFCTEVfQ09OVEFJTkVSLiIgU0VUIG5hbWU9JyVzJywgb2JqPSclcycsIGRhdGVfYWRkZWQ9Tk9XKCkgd2hlcmUgbmFtZT0nbWVtYmVybW91c2VzZXJ2aWNlJyBMSU1JVCAxIjsKCQkJCX0KCQkJCQoJCQkJaWYoJHdwZGItPnF1ZXJ5KCR3cGRiLT5wcmVwYXJlKCRzcWwsICRjbGFzc05hbWUsICRjbGFzc0VudHJ5KSkpCgkJCQl7CgkJCQkJJGNhY2hlUmVzdWx0ID0gc2VsZjo6Y2FjaGVDbGFzcygkY2xhc3NOYW1lLCAkY2xhc3NFbnRyeSk7CgkJCQl9CgkJCX0KCQkJDQoJCQlNTV9TZXNzaW9uOjp2YWx1ZShNTV9TZXNzaW9uOjokS0VZX1VTSU5HX0RCX0NBQ0hFLCAhJGNhY2hlUmVzdWx0KTsKCQl9CgkJCgkJcmV0dXJuIHRydWU7Cgl9CgoJcHJpdmF0ZSBzdGF0aWMgZnVuY3Rpb24gY2FjaGVDbGFzcygkY2xhc3NOYW1lLCAkY2xhc3NFbnRyeSkKCXsKCQkkZmlsZVBhdGggPSBNTV9QTFVHSU5fQUJTUEFUSC4iL2NvbS9tZW1iZXJtb3VzZS9jYWNoZSI7CgkJCgkJaWYoaXNfZGlyKCRmaWxlUGF0aCkpCgkJewoJCQlpZihpc193cml0ZWFibGUoJGZpbGVQYXRoKSkKCQkJewoJCQkJaWYocHJlZ19tYXRjaCgiLyhtZW1iZXJtb3VzZV9zY2hlbWEpJC8iLCAkY2xhc3NOYW1lKSkKCQkJCXsKCQkJCQkkZmlsZVBhdGggLj0gIi8iLiRjbGFzc05hbWUuIi5zcWwiOwoJCQkJfQoJCQkJZWxzZQoJCQkJewoJCQkJCSRmaWxlUGF0aCAuPSAiLyIuYmFzZTY0X2VuY29kZSgkY2xhc3NOYW1lKS4iLmNhY2hlIjsKCQkJCX0KCQkJCQoJCQkJJGZoID0gZm9wZW4oJGZpbGVQYXRoLCAndycpOwoJCQkJZndyaXRlKCRmaCwgJGNsYXNzRW50cnkpOwoJCQkJZmNsb3NlKCRmaCk7CgkJCQkKCQkJCWlmKGZpbGVfZXhpc3RzKCRmaWxlUGF0aCkpCgkJCQl7CgkJCQkJQGNobW9kKCRmaWxlUGF0aCwgMDc3Nyk7CgkJCQl9CgkJCQkKCQkJCXJldHVybiB0cnVlOwoJCQl9CgkJCWVsc2UKCQkJewoJCQkJcmV0dXJuIGZhbHNlOwoJCQl9CgkJfQoJCWVsc2UKCQl7CgkJCXJldHVybiBmYWxzZTsKCQl9Cgl9CgkKCXByaXZhdGUgc3RhdGljIGZ1bmN0aW9uIHNlbmRSZXF1ZXN0KCRtZXRob2QsICRwb3N0dmFycykKCXsKCQkkdXJsID0gc2VsZjo6JFNFUlZFUklQLiRtZXRob2Q7CgkKCQkkY2ggPSBjdXJsX2luaXQoJHVybCk7CgkJY3VybF9zZXRvcHQoJGNoLCBDVVJMT1BUX1BPU1QgICAgICAsMSk7CgkJY3VybF9zZXRvcHQoJGNoLCBDVVJMT1BUX1BPU1RGSUVMRFMgICAgLCAkcG9zdHZhcnMpOwoJCWN1cmxfc2V0b3B0KCRjaCwgQ1VSTE9QVF9IRUFERVIgICAgICAsMCk7ICAvLyBETyBOT1QgUkVUVVJOIEhUVFAgSEVBREVSUwoJCWN1cmxfc2V0b3B0KCRjaCwgQ1VSTE9QVF9SRVRVUk5UUkFOU0ZFUiAgLDEpOyAgLy8gUkVUVVJOIFRIRSBDT05URU5UUyBPRiBUSEUgQ0FMTAoJCSRyZXN1bHQgPSBjdXJsX2V4ZWMoJGNoKTsKCQljdXJsX2Nsb3NlKCRjaCk7CgkJCgkJaWYoJHJlc3VsdCA9PT0gZmFsc2UgfHwgc3RycG9zKCRyZXN1bHQsICdyZXNwb25zZV9jb2RlJykgPT09IGZhbHNlKQoJCXsKCQkJLy8gdW5hYmxlIHRvIGNvbm5lY3QgdG8gc2VydmVyCgkJCXJldHVybiBmYWxzZTsKCQl9CgkJZWxzZSAKCQl7CgkJCSRqc29uID0ganNvbl9kZWNvZGUoJHJlc3VsdCk7CgkJCQoJCQlpZighaXNfbnVsbCgkanNvbikgJiYgaXNzZXQoJGpzb24tPnJlc3BvbnNlX2RhdGEpKQoJCQl7CQoJCQkJJG9yaWdSZXNwb25zZSA9ICRqc29uLT5yZXNwb25zZV9kYXRhOwoJCQkJaWYoaXNfc3RyaW5nKCRqc29uLT5yZXNwb25zZV9kYXRhKSkKCQkJCXsKCQkJCQkkanNvbi0+cmVzcG9uc2VfZGF0YSA9IGpzb25fZGVjb2RlKCRqc29uLT5yZXNwb25zZV9kYXRhKTsKCQkJCQkJCgkJCQkJaWYoaXNfbnVsbCgkanNvbi0+cmVzcG9uc2VfZGF0YSkpCgkJCQkJewoJCQkJCQkkanNvbi0+cmVzcG9uc2VfZGF0YSA9ICRvcmlnUmVzcG9uc2U7CgkJCQkJfQoJCQkJfQoJCQkKCQkJCS8vIHZhbGlkYXRlIGxpY2Vuc2UgZGF0YSBmb3IgYXV0aG9yaXphdGlvbnMKCQkJCWlmKCRtZXRob2QgPT0gc2VsZjo6JE1FVEhPRF9BVVRIT1JJWkUgJiYgKCFpc3NldCgkanNvbi0+cmVzcG9uc2VfZGF0YS0+bGljZW5zZURhdGEpIHx8ICFpc3NldCgkanNvbi0+cmVzcG9uc2VfZGF0YS0+bGljZW5zZURhdGEtPmlkKSkpCgkJCQl7CgkJCQkJJGVycm9yID0gbmV3IHN0ZENsYXNzKCk7CgkJCQkJJGVycm9yLT5yZXNwb25zZV9jb2RlID0gIjQwMSI7CgkJCQkJcmV0dXJuICRlcnJvcjsKCQkJCX0KCQkJCQoJCQkJcmV0dXJuICRqc29uOwoJCQl9CgkJCWVsc2UgCgkJCXsKCQkJCS8vIGxpY2Vuc2UgaXMgY2FuY2VsZWQKCQkJCSRlcnJvciA9IG5ldyBzdGRDbGFzcygpOwoJCQkJJGVycm9yLT5yZXNwb25zZV9jb2RlID0gIjQwMSI7CgkJCQlyZXR1cm4gJGVycm9yOwoJCQl9CgkJfQoJfQoNCglwdWJsaWMgc3RhdGljIGZ1bmN0aW9uIGlzU3VjY2Vzc2Z1bFJlc3VsdCgkcmVzdWx0KQ0KCXsNCgkJaWYoIWlzX251bGwoJHJlc3VsdCkgJiYgKCRyZXN1bHQtPnJlc3BvbnNlX2NvZGUgPT0gIjIwMCIpKQ0KCQl7DQoJCQlyZXR1cm4gdHJ1ZTsNCgkJfQ0KCQ0KCQlyZXR1cm4gZmFsc2U7DQoJfQoJCgkKCS8qKiBTSVRFIFNUQVRTIEFORCBQUk9QRVJUSUVTICoqLwoJCglwdWJsaWMgc3RhdGljIGZ1bmN0aW9uIGdlbmVyYXRlU3RhdGlzdGljcygpCgl7CgkJZ2xvYmFsICR3cGRiOwoJCQoJCSRzdGF0aXN0aWNzID0gYXJyYXkoKTsKCQkKCQkvLyBQQUlEIE1FTUJFUlMgKFVTQUdFKQoJCSRiYXNlU3FsID0gIlNFTEVDVCBjb3VudCh1LndwX3VzZXJfaWQpIGFzIHRvdGFsIEZST00gIi5NTV9UQUJMRV9VU0VSX0RBVEEuIiB1LCAiLk1NX1RBQkxFX01FTUJFUlNISVBfTEVWRUxTLiIgbSBXSEVSRSAiOwoJCSRiYXNlU3FsIC49ICJ1Lm1lbWJlcnNoaXBfbGV2ZWxfaWQgPSBtLmlkIEFORCAodS5zdGF0dXMgPSAnIi5NTV9TdGF0dXM6OiRBQ1RJVkUuIicgT1IgdS5zdGF0dXMgPSAnIi5NTV9TdGF0dXM6OiRQRU5ESU5HX0NBTkNFTExBVElPTi4iJykgIjsKCQkKCQkkcmVzdWx0ID0gJHdwZGItPmdldF9yb3coJGJhc2VTcWwuIiBBTkQgbS5pc19mcmVlICE9ICcxJzsiKTsKCQkKCQlpZigkcmVzdWx0KQoJCXsKCQkJJHBhaWRNZW1iZXJzID0gJHJlc3VsdC0+dG90YWw7CgkJfQoJCWVsc2UKCQl7CgkJCSRwYWlkTWVtYmVycyA9IDA7CgkJfQoJCQoJCSRzdGF0aXN0aWNzW3NlbGY6OiRVU0FHRV9QQUlEX01FTUJFUlNdID0gJHBhaWRNZW1iZXJzOwoJCQoJCS8vIEZSRUUgTUVNQkVSUyAoVVNBR0UpCgkJJHJlc3VsdCA9ICR3cGRiLT5nZXRfcm93KCRiYXNlU3FsLiIgQU5EIG0uaXNfZnJlZSA9ICcxJzsiKTsKCQkKCQlpZigkcmVzdWx0KQoJCXsKCQkJJGZyZWVNZW1iZXJzID0gJHJlc3VsdC0+dG90YWw7CgkJfQoJCWVsc2UKCQl7CgkJCSRmcmVlTWVtYmVycyA9IDA7CgkJfQoJCQ0KCQkkc3RhdGlzdGljc1tzZWxmOjokVVNBR0VfRlJFRV9NRU1CRVJTXSA9ICRmcmVlTWVtYmVyczsKCQkKCQkvLyBQQUlEIEJVTkRMRVMgKFVTQUdFKQoJCSRiYXNlU3FsID0gIlNFTEVDVCBjb3VudCgxKSBhcyB0b3RhbF9idW5kbGVzIEZST00gIi5NTV9UQUJMRV9BUFBMSUVEX0JVTkRMRVMuIiBhcHBCdW5kbGVzLCB7JHdwZGItPnVzZXJzfSB1c2VycywgIjsNCgkJJGJhc2VTcWwgLj0gTU1fVEFCTEVfQlVORExFUy4iIGJ1bmRsZXMgV0hFUkUgYXBwQnVuZGxlcy5hY2Nlc3NfdHlwZT0nIi5NTV9BcHBsaWVkQnVuZGxlOjokQUNDRVNTX1RZUEVfVVNFUi4iJyBBTkQgYXBwQnVuZGxlcy5hY2Nlc3NfdHlwZV9pZCA9IHVzZXJzLmlkICI7CgkJJGJhc2VTcWwgLj0gIkFORCAoYXBwQnVuZGxlcy5zdGF0dXM9JyIuTU1fU3RhdHVzOjokQUNUSVZFLiInIE9SIGFwcEJ1bmRsZXMuc3RhdHVzPSciLk1NX1N0YXR1czo6JFBFTkRJTkdfQ0FOQ0VMTEFUSU9OLiInKSBBTkQgYXBwQnVuZGxlcy5idW5kbGVfaWQgPSBidW5kbGVzLmlkICI7CgkJCgkJJHJlc3VsdCA9ICR3cGRiLT5nZXRfcm93KCRiYXNlU3FsLiIgQU5EIGJ1bmRsZXMuaXNfZnJlZSA9ICcwJzsiKTsKCQkKCQlpZigkcmVzdWx0KQoJCXsKCQkJJHBhaWRCdW5kbGVzID0gJHJlc3VsdC0+dG90YWxfYnVuZGxlczsKCQl9CgkJZWxzZQoJCXsKCQkJJHBhaWRCdW5kbGVzID0gMDsKCQl9CgkJCgkJJHN0YXRpc3RpY3Nbc2VsZjo6JFVTQUdFX1BBSURfQlVORExFU10gPSAkcGFpZEJ1bmRsZXM7CgkJCgkJLy8gRlJFRSBCVU5ETEVTIChVU0FHRSkKCQkkcmVzdWx0ID0gJHdwZGItPmdldF9yb3coJGJhc2VTcWwuIiBBTkQgYnVuZGxlcy5pc19mcmVlID0gJzEnOyIpOwoJCQoJCWlmKCRyZXN1bHQpCgkJewoJCQkkZnJlZUJ1bmRsZXMgPSAkcmVzdWx0LT50b3RhbF9idW5kbGVzOwoJCX0KCQllbHNlCgkJewoJCQkkZnJlZUJ1bmRsZXMgPSAwOwoJCX0KCQkKCQkkc3RhdGlzdGljc1tzZWxmOjokVVNBR0VfRlJFRV9CVU5ETEVTXSA9ICRmcmVlQnVuZGxlczsKCgkJLy8gT1JERVJTCgkJJGJhc2VTcWwgPSAiU0VMRUNUIGNvdW50KG8uaWQpIGFzIHRvdGFsIEZST00gIi5NTV9UQUJMRV9PUkRFUlMuIiBvIjsKCQkKCQkkcmVzdWx0ID0gJHdwZGItPmdldF9yb3coJGJhc2VTcWwpOw0KCQkNCgkJaWYoJHJlc3VsdCkNCgkJew0KCQkJJG9yZGVycyA9ICRyZXN1bHQtPnRvdGFsOw0KCQl9DQoJCWVsc2UNCgkJew0KCQkJJG9yZGVycyA9IDA7DQoJCX0KCQkNCgkJJHN0YXRpc3RpY3Nbc2VsZjo6JFVTQUdFX09SREVSU10gPSAkb3JkZXJzOwoJCQoJCS8vIFBBWU1FTlQgTUVUSE9EUwoJCSRwYXltZW50TWV0aG9kcyA9IGFycmF5KCk7CgkJCgkJJHNlcnZpY2VzID0gTU1fUGF5bWVudFNlcnZpY2VGYWN0b3J5OjpnZXRBdmFpbGFibGVQYXltZW50U2VydmljZXMoKTsNCgkJCQ0KCQlmb3JlYWNoICgkc2VydmljZXMgYXMgJHNlcnZpY2UpDQoJCXsNCgkJCWlmICgkc2VydmljZSBpbnN0YW5jZW9mIE1NX1BheW1lbnRTZXJ2aWNlKQ0KCQkJew0KCQkJCWFycmF5X3B1c2goJHBheW1lbnRNZXRob2RzLCAkc2VydmljZS0+Z2V0VG9rZW4oKSk7CgkJCX0KCQl9CgkJDQoJCSRzdGF0aXN0aWNzW3NlbGY6OiRDT05GSUdfUEFZTUVOVF9NRVRIT0RTXSA9IGpvaW4oIiwgIiwgJHBheW1lbnRNZXRob2RzKTsKCQkKCQkvLyBQQUlEIE1FTUJFUlNISVAgTEVWRUxTCgkJJHBhaWRNZW1iZXJzaGlwcyA9IE1NX01lbWJlcnNoaXBMZXZlbDo6Z2V0TWVtYmVyc2hpcExldmVsc0xpc3QoZmFsc2UsIE1NX01lbWJlcnNoaXBMZXZlbDo6JFNVQl9UWVBFX1BBSUQpOwoJCQoJCWlmKCRwYWlkTWVtYmVyc2hpcHMgJiYgaXNfYXJyYXkoJHBhaWRNZW1iZXJzaGlwcykpCgkJew0KCQkJJHN0YXRpc3RpY3Nbc2VsZjo6JENPTkZJR19NRU1CRVJTSElQU19QQUlEXSA9IGNvdW50KCRwYWlkTWVtYmVyc2hpcHMpOwoJCX0KCQllbHNlIAoJCXsKCQkJJHN0YXRpc3RpY3Nbc2VsZjo6JENPTkZJR19NRU1CRVJTSElQU19QQUlEXSA9IDA7CgkJfQoJCQoJCS8vIEZSRUUgTUVNQkVSU0hJUCBMRVZFTFMKCQkkZnJlZU1lbWJlcnNoaXBzID0gTU1fTWVtYmVyc2hpcExldmVsOjpnZXRNZW1iZXJzaGlwTGV2ZWxzTGlzdChmYWxzZSwgTU1fTWVtYmVyc2hpcExldmVsOjokU1VCX1RZUEVfRlJFRSk7DQoJCQ0KCQlpZigkZnJlZU1lbWJlcnNoaXBzICYmIGlzX2FycmF5KCRmcmVlTWVtYmVyc2hpcHMpKQ0KCQl7DQoJCQkkc3RhdGlzdGljc1tzZWxmOjokQ09ORklHX01FTUJFUlNISVBTX0ZSRUVdID0gY291bnQoJGZyZWVNZW1iZXJzaGlwcyk7DQoJCX0NCgkJZWxzZQ0KCQl7DQoJCQkkc3RhdGlzdGljc1tzZWxmOjokQ09ORklHX01FTUJFUlNISVBTX0ZSRUVdID0gMDsNCgkJfQoJCQoJCS8vIFBBSUQgQlVORExFUw0KCQkkcGFpZEJ1bmRsZXMgPSBNTV9CdW5kbGU6OmdldEJ1bmRsZXNMaXN0KGZhbHNlLCBNTV9CdW5kbGU6OiRTVUJfVFlQRV9QQUlEKTsNCgkJDQoJCWlmKCRwYWlkQnVuZGxlcyAmJiBpc19hcnJheSgkcGFpZEJ1bmRsZXMpKQ0KCQl7DQoJCQkkc3RhdGlzdGljc1tzZWxmOjokQ09ORklHX0JVTkRMRVNfUEFJRF0gPSBjb3VudCgkcGFpZEJ1bmRsZXMpOw0KCQl9DQoJCWVsc2UNCgkJew0KCQkJJHN0YXRpc3RpY3Nbc2VsZjo6JENPTkZJR19CVU5ETEVTX1BBSURdID0gMDsNCgkJfQ0KCQkNCgkJLy8gRlJFRSBCVU5ETEVTDQoJCSRmcmVlQnVuZGxlcyA9IE1NX0J1bmRsZTo6Z2V0QnVuZGxlc0xpc3QoZmFsc2UsIE1NX0J1bmRsZTo6JFNVQl9UWVBFX0ZSRUUpOw0KCQkNCgkJaWYoJGZyZWVCdW5kbGVzICYmIGlzX2FycmF5KCRmcmVlQnVuZGxlcykpDQoJCXsNCgkJCSRzdGF0aXN0aWNzW3NlbGY6OiRDT05GSUdfQlVORExFU19GUkVFXSA9IGNvdW50KCRmcmVlQnVuZGxlcyk7DQoJCX0NCgkJZWxzZQ0KCQl7DQoJCQkkc3RhdGlzdGljc1tzZWxmOjokQ09ORklHX0JVTkRMRVNfRlJFRV0gPSAwOw0KCQl9CgkJCgkJLy8gUFJPRFVDVFMKCQkkcHJvZHVjdHMgPSBNTV9Qcm9kdWN0OjpnZXRBbGwoKTsKCQkKCQlpZigkcHJvZHVjdHMgJiYgaXNfYXJyYXkoJHByb2R1Y3RzKSkNCgkJew0KCQkJJHN0YXRpc3RpY3Nbc2VsZjo6JENPTkZJR19QUk9EVUNUU10gPSBjb3VudCgkcHJvZHVjdHMpOw0KCQl9DQoJCWVsc2UNCgkJew0KCQkJJHN0YXRpc3RpY3Nbc2VsZjo6JENPTkZJR19QUk9EVUNUU10gPSAwOw0KCQl9CgkJCgkJLy8gREVGQVVMVCBFTVBMT1lFRSBBQ0NPVU5UCgkJJGVtcGxveWVlID0gTU1fRW1wbG95ZWU6OmdldERlZmF1bHQoKTsNCgkJJHN0YXRpc3RpY3Nbc2VsZjo6JENPTkZJR19ERUZBVUxUX0VNUExPWUVFX0VNQUlMXSA9ICIiOw0KCQkkc3RhdGlzdGljc1tzZWxmOjokQ09ORklHX0RFRkFVTFRfRU1QTE9ZRUVfTkFNRV0gPSAiIjsKCQkKCQlpZigkZW1wbG95ZWUtPmlzVmFsaWQoKSkKCQl7CgkJCSRzdGF0aXN0aWNzW3NlbGY6OiRDT05GSUdfREVGQVVMVF9FTVBMT1lFRV9FTUFJTF0gPSAkZW1wbG95ZWUtPmdldEVtYWlsKCk7CgkJCSRzdGF0aXN0aWNzW3NlbGY6OiRDT05GSUdfREVGQVVMVF9FTVBMT1lFRV9OQU1FXSA9ICRlbXBsb3llZS0+Z2V0RGlzcGxheU5hbWUoKTsKCQl9CgkJCgkJJHN0YXRpc3RpY3Nbc2VsZjo6JENPTkZJR19DVVJSRU5DWV0gPSBNTV9PcHRpb25VdGlsczo6Z2V0T3B0aW9uKE1NX09wdGlvblV0aWxzOjokT1BUSU9OX0tFWV9DVVJSRU5DWSk7CgkJCgkJcmV0dXJuICRzdGF0aXN0aWNzOwoJfQoJCglwdWJsaWMgc3RhdGljIGZ1bmN0aW9uIGdlbmVyYXRlUHJvcGVydGllcygpCgl7CgkJZ2xvYmFsICR3cF92ZXJzaW9uOwoJCSRwcm9wZXJ0aWVzID0gYXJyYXkoKTsKCQkKCQkkcHJvcGVydGllc1tzZWxmOjokUFJPUFNfV1BfVkVSU0lPTl0gPSAkd3BfdmVyc2lvbjsKCQkkcHJvcGVydGllc1tzZWxmOjokUFJPUFNfUEhQX1ZFUlNJT05dID0gcGhwdmVyc2lvbigpOwoJCQoJCXJldHVybiAkcHJvcGVydGllczsKCX0KCQoJCgkvKiogUEVSTUlTU0lPTlMgKiovCgkNCglwdWJsaWMgc3RhdGljICRQWU1UX1NFUlZJQ0VfQVVUSE9SSVpFTkVUID0gInB5bXRfc2VydmljZV9hdXRob3JpemVuZXQiOwoJcHVibGljIHN0YXRpYyAkUFlNVF9TRVJWSUNFX0FVVEhPUklaRU5FVF9DSU0gPSAicHltdF9zZXJ2aWNlX2F1dGhvcml6ZW5ldF9jaW0iOwoJcHVibGljIHN0YXRpYyAkUFlNVF9TRVJWSUNFX1BBWVBBTCA9ICJweW10X3NlcnZpY2VfcGF5cGFsIjsKCXB1YmxpYyBzdGF0aWMgJFBZTVRfU0VSVklDRV9DTElDS0JBTksgPSAicHltdF9zZXJ2aWNlX2NsaWNrYmFuayI7CglwdWJsaWMgc3RhdGljICRQWU1UX1NFUlZJQ0VfQ0hBUkdJRlkgPSAicHltdF9zZXJ2aWNlX2NoYXJnaWZ5IjsKCXB1YmxpYyBzdGF0aWMgJFBZTVRfU0VSVklDRV9TVFJJUEUgPSAicHltdF9zZXJ2aWNlX3N0cmlwZSI7CglwdWJsaWMgc3RhdGljICRQWU1UX1NFUlZJQ0VfQlJBSU5UUkVFID0gInB5bXRfc2VydmljZV9icmFpbnRyZWUiOwoJcHVibGljIHN0YXRpYyAkUFlNVF9TRVJWSUNFX0xJTUVMSUdIVCA9ICJweW10X3NlcnZpY2VfbGltZWxpZ2h0IjsKCXB1YmxpYyBzdGF0aWMgJFBZTVRfU0VSVklDRV9MSVRMRSA9ICJweW10X3NlcnZpY2VfbGl0bGUiOwoJcHVibGljIHN0YXRpYyAkUFlNVF9TRVJWSUNFX0NPSU5CQVNFID0gInB5bXRfc2VydmljZV9jb2luYmFzZSI7CglwdWJsaWMgc3RhdGljICRNQVhfTlVNQkVSX01FTUJFUlMgPSAibWF4X251bWJlcl9tZW1iZXJzIjsKCXB1YmxpYyBzdGF0aWMgJFNIT1dfTU1fRk9PVEVSID0gInNob3dfbW1fZm9vdGVyIjsKCXB1YmxpYyBzdGF0aWMgJEZFQVRVUkVfQlVORExFUyA9ICJmZWF0dXJlX2J1bmRsZXMiOwoJcHVibGljIHN0YXRpYyAkRkVBVFVSRV9EUklQX0NPTlRFTlRfU0NIRURVTEUgPSAiZmVhdHVyZV9kcmlwX2NvbnRlbnRfc2NoZWR1bGUiOwoJcHVibGljIHN0YXRpYyAkRkVBVFVSRV9QSFBfSU5URVJGQUNFID0gImZlYXR1cmVfcGhwX2ludGVyZmFjZSI7CglwdWJsaWMgc3RhdGljICRGRUFUVVJFX1BVU0hfTk9USUZJQ0FUSU9OUyA9ICJmZWF0dXJlX3B1c2hfbm90aWZpY2F0aW9ucyI7CglwdWJsaWMgc3RhdGljICRGRUFUVVJFX0FQSSA9ICJmZWF0dXJlX2FwaSI7CglwdWJsaWMgc3RhdGljICRGRUFUVVJFX1NNQVJUX0NPTlRFTlRfVEFHUyA9ICJmZWF0dXJlX3NtYXJ0X2NvbnRlbnRfdGFncyI7CglwdWJsaWMgc3RhdGljICRGRUFUVVJFX0FGRklMSUFURV9NR01UID0gImZlYXR1cmVfYWZmaWxpYXRlX21nbXQiOwoJcHVibGljIHN0YXRpYyAkRkVBVFVSRV9MT0FEX0JBTEFOQ0lORyA9ICJmZWF0dXJlX2xvYWRfYmFsYW5jaW5nIjsKCXB1YmxpYyBzdGF0aWMgJEZFQVRVUkVfRU1QTE9ZRUVfQUNDT1VOVFMgPSAiZmVhdHVyZV9lbXBsb3llZV9hY2NvdW50cyI7CglwdWJsaWMgc3RhdGljICRGRUFUVVJFX0FEVl9TVUJTQ1JJUFRJT05fTUdNVCA9ICJmZWF0dXJlX2Fkdl9zdWJzY3JpcHRpb25fbWdtdCI7CglwdWJsaWMgc3RhdGljICRGRUFUVVJFX1JFUE9SVElOR19TVUlURSA9ICJmZWF0dXJlX3JlcG9ydGluZ19zdWl0ZSI7CglwdWJsaWMgc3RhdGljICRFWFRFTlNJT05fVVNFUlZPSUNFID0gImV4dGVuc2lvbl91c2Vydm9pY2UiOwoJcHVibGljIHN0YXRpYyAkRVhURU5TSU9OX1NPQ0lBTF9MT0dJTiA9ICJleHRlbnNpb25fc29jaWFsX2xvZ2luIjsKCXB1YmxpYyBzdGF0aWMgJEVYVEVOU0lPTl9HT09HTEVfRUNPTU1FUkNFID0gImV4dGVuc2lvbl9nb29nbGVfZWNvbW1lcmNlIjsKCXB1YmxpYyBzdGF0aWMgJFNVUFBPUlRfRU1BSUwgPSAic3VwcG9ydF9lbWFpbCI7CglwdWJsaWMgc3RhdGljICRTVVBQT1JUX1BIT05FID0gInN1cHBvcnRfcGhvbmUiOwoJcHVibGljIHN0YXRpYyAkVU5MSU1JVEVEX01FTUJFUlMgPSAtMTsKCQoJcHVibGljIHN0YXRpYyAkQUNUSVZFID0gMTsNCglwdWJsaWMgc3RhdGljICRJTkFDVElWRSA9IDA7CgkNCglwdWJsaWMgc3RhdGljIGZ1bmN0aW9uIGhhc1Blcm1pc3Npb24oJGtleSkNCgl7DQoJCSRsaWNlbnNlID0gbmV3IE1NX0xpY2Vuc2UoKTsKCQkKCQlpZigkbGljZW5zZS0+aXNWYWxpZCgpKQoJCXsKCQkJJHBlcm1pc3Npb25zID0gJGxpY2Vuc2UtPmdldFBlcm1pc3Npb25zKCk7CgkJCQoJCQlpZigkcGVybWlzc2lvbnMpCgkJCXsKCQkJCSRwZXJtaXNzaW9ucyA9IGpzb25fZGVjb2RlKCRwZXJtaXNzaW9ucyk7CgkJCQkNCgkJCQlpZihpc19vYmplY3QoJHBlcm1pc3Npb25zKSAmJiBpc3NldCgkcGVybWlzc2lvbnMtPiRrZXkpKQ0KCQkJCXsNCgkJCQkJcmV0dXJuICRwZXJtaXNzaW9ucy0+JGtleTsNCgkJCQl9CgkJCX0KCQkJCgkJCXJldHVybiBzZWxmOjokSU5BQ1RJVkU7CgkJfQ0KCX0KCQoJcHVibGljIHN0YXRpYyBmdW5jdGlvbiBnZXRNZW1iZXJMaW1pdCgpCgl7CgkJJGxpY2Vuc2UgPSBuZXcgTU1fTGljZW5zZSgpOw0KCQkNCgkJaWYoJGxpY2Vuc2UtPmlzVmFsaWQoKSkNCgkJew0KCQkJJHBlcm1pc3Npb25zID0gJGxpY2Vuc2UtPmdldFBlcm1pc3Npb25zKCk7DQoJCQkJDQoJCQlpZigkcGVybWlzc2lvbnMpDQoJCQl7DQoJCQkJJHBlcm1pc3Npb25zID0ganNvbl9kZWNvZGUoJHBlcm1pc3Npb25zKTsKCQkJCQoJCQkJaWYoaXNfb2JqZWN0KCRwZXJtaXNzaW9ucykgJiYgaXNzZXQoJHBlcm1pc3Npb25zLT5tYXhfbnVtYmVyX21lbWJlcnMpKQ0KCQkJCXsKCQkJCQlyZXR1cm4gJHBlcm1pc3Npb25zLT5tYXhfbnVtYmVyX21lbWJlcnM7CgkJCQl9CgkJCX0KCQl9CgkJCgkJcmV0dXJuIC0xOwoJfQoJCglwdWJsaWMgc3RhdGljIGZ1bmN0aW9uIGdldFVwZ3JhZGVVcmwoJGZlYXR1cmU9IiIpCgl7CgkJJGxpY2Vuc2UgPSBuZXcgTU1fTGljZW5zZSgpOwoJCWlmKGVtcHR5KCRmZWF0dXJlKSkKCQl7CgkJCSR1cmwgPSAiaHR0cHM6Ly9tZW1iZXJtb3VzZS5jb20vY2hlY2tvdXQvP3BpZD0iOwoJCQkKCQkJc3dpdGNoKCRsaWNlbnNlLT5nZXRwZXJtaXNzaW9uc1Byb2ZpbGVJZCgpKQoJCQl7CgkJCQkvLyBmcmVlCgkJCQljYXNlIDE6CgkJCQkJcmV0dXJuICJodHRwczovL21lbWJlcm1vdXNlLmNvbS9jaGVja291dC8/cmlkPXBLNEUxOCI7CgoJCQkJLy8gc3RhcnRlciB2MQoJCQkJY2FzZSAyOgoJCQkJCXJldHVybiAiaHR0cHM6Ly9tZW1iZXJtb3VzZS5jb20vY2hlY2tvdXQvP3JpZD1wdzQyMzciOwoJCQkJCgkJCQkvLyBncm93dGggdjEKCQkJCWNhc2UgMzogCgkJCQkJcmV0dXJuICJodHRwczovL21lbWJlcm1vdXNlLmNvbS9jaGVja291dC8/cmlkPXB3NDIzNyI7CgkJCQkKCQkJCS8vIHByb2Zlc3Npb25hbCB2MQoJCQkJY2FzZSA0OgoJCQkJCXJldHVybiAiaHR0cHM6Ly9tZW1iZXJtb3VzZS5jb20vY2hlY2tvdXQvP3JpZD1wdkJRdEgiOwoJCQkJCQoJCQkJLy8gc3RhcnRlciB2MgoJCQkJY2FzZSA1OgoJCQkJCXJldHVybiAiaHR0cHM6Ly9tZW1iZXJtb3VzZS5jb20vY2hlY2tvdXQvP3JpZD1waldiOG4iOwoJCQkJCQoJCQkJLy8gYnVpbGRlciB2MgoJCQkJY2FzZSA2OgoJCQkJCXJldHVybiAiaHR0cHM6Ly9tZW1iZXJtb3VzZS5jb20vY2hlY2tvdXQvP3JpZD1wTld4a1MiOwoJCQkJCQoJCQkJLy8gZ3Jvd3RoIHYyCgkJCQljYXNlIDc6CgkJCQkJcmV0dXJuICJodHRwczovL21lbWJlcm1vdXNlLmNvbS9jaGVja291dC8/cmlkPXB3NDIzNyI7CgkJCQkJCgkJCQkvLyBhZHZhbmNlZCB2MgoJCQkJY2FzZSAxMDoKCQkJCQlyZXR1cm4gImh0dHBzOi8vbWVtYmVybW91c2UuY29tL2NoZWNrb3V0Lz9yaWQ9cDROdTF1IjsKCQkJCQkKCQkJCS8vIHByZW1pdW0gdjIKCQkJCWNhc2UgODoKCQkJCQlyZXR1cm4gImh0dHBzOi8vbWVtYmVybW91c2UuY29tL2NoZWNrb3V0Lz9yaWQ9cHZCUXRIIjsKCQkJCQkKCQkJCS8vIHByb2Zlc3Npb25hbCB2MgoJCQkJY2FzZSA5OgoJCQkJCXJldHVybiAiaHR0cHM6Ly9tZW1iZXJtb3VzZS5jb20vY2hlY2tvdXQvP3JpZD1wdkJRdEgiOwoJCQkJCQoJCQkJZGVmYXVsdDoKCQkJCQlyZXR1cm4gJHVybDsKCQkJfQoJCX0KCQllbHNlCgkJewoJCQlyZXR1cm4gImh0dHA6Ly9tZW1iZXJtb3VzZS5jb20vdXBncmFkZS5waHA/cHJvZmlsZWlkPSIuJGxpY2Vuc2UtPmdldHBlcm1pc3Npb25zUHJvZmlsZUlkKCkuIiZmZWF0dXJlPSIuJGZlYXR1cmU7CgkJfQoJfQ0KCQ0KCXB1YmxpYyBzdGF0aWMgZnVuY3Rpb24gZ2V0UGx1Z2luVmVyc2lvbigpDQoJew0KCQkkY29udGVudHMgPSBmaWxlX2dldF9jb250ZW50cyhNTV9QTFVHSU5fQUJTUEFUSC4iL2luZGV4LnBocCIpOw0KCQlwcmVnX21hdGNoKCIvKFxAdmVyc2lvbilbMC05XC5cc10rLyIsICRjb250ZW50cywgJG1hdGNoKTsNCgkJcmV0dXJuICgoaXNzZXQoJG1hdGNoWzBdKSk/cHJlZ19yZXBsYWNlKCIvKFxAdmVyc2lvbilbXHNdKy8iLCIiLCB0cmltKCRtYXRjaFswXSkpOiIiKTsNCgl9DQoJDQoJcHJpdmF0ZSBzdGF0aWMgZnVuY3Rpb24gaW5pdGlhdGVQbHVnaW5EZWFjdGl2YXRpb24oKQ0KCXsNCgkJLy8gaWYgbG9nZ2VkIGluIGFzIGFuIGFkbWluIGFuZCBpbiB0aGUgYWRtaW4gYXJlYSwgZGlzYWJsZSB0aGUgcGx1Z2luIHRocm91Z2ggV29yZFByZXNzLCBvdGhlcndpc2UNCgkJLy8gbWFudWFsbHkgZGVhY3RpdmF0ZSB0aGUgcGx1Z2luIHRocm91Z2ggdGhlIGRhdGFiYXNlDQoJCWlmKGlzX2FkbWluKCkpDQoJCXsKCQkJaWYoIXByZWdfbWF0Y2goIi8ocGx1Z2luc1wucGhwKS8iLCAkX1NFUlZFUlsiUEhQX1NFTEYiXSkpCgkJCXsNCgkJCQloZWFkZXIoIkxvY2F0aW9uOiBwbHVnaW5zLnBocD8iLk1NX1Nlc3Npb246OiRQQVJBTV9DT01NQU5EX0RFQUNUSVZBVEUuIj0xJmRlYWN0aXZhdGU9dHJ1ZSIpOwoJCQl9DQoJCX0NCgkJZWxzZQ0KCQl7DQoJCQlzZWxmOjptYW51YWxseURlYWN0aXZhdGVQbHVnaW4oKTsNCgkJfQ0KCX0NCgkNCglwcml2YXRlIHN0YXRpYyBmdW5jdGlvbiBtYW51YWxseURlYWN0aXZhdGVQbHVnaW4oKQ0KCXsNCgkJJHBsdWdpbnMgPSBnZXRfb3B0aW9uKCdhY3RpdmVfcGx1Z2lucycpOw0KCQ0KCQlpZihpc19hcnJheSgkcGx1Z2lucykgJiYgY291bnQoJHBsdWdpbnMpID4gMCkNCgkJew0KCQkJJHBsdWdpbk5hbWUgPSBNTV9QTFVHSU5fTkFNRS4iL2luZGV4LnBocCI7DQoJCQkka2V5ID0gYXJyYXlfc2VhcmNoKCRwbHVnaW5OYW1lLCAkcGx1Z2lucywgdHJ1ZSk7DQoJCQkJDQoJCQlpZigka2V5ICE9PSBmYWxzZSkNCgkJCXsNCgkJCQl1bnNldCgkcGx1Z2luc1ska2V5XSk7DQoJCQl9DQoJCQkJDQoJCQl1cGRhdGVfb3B0aW9uKCJhY3RpdmVfcGx1Z2lucyIsICRwbHVnaW5zKTsNCgkJCQoJCQkvLyBzZW5kIGFuIGVtYWlsIHRvIHRoZSBkZWZhdWx0IGVtcGxveWVlCgkJCSRlbXBsb3llZSA9IE1NX0VtcGxveWVlOjpnZXREZWZhdWx0KCk7CgkJCSRlbWFpbCA9IG5ldyBNTV9FbWFpbCgpOw0KCQkJJGVtYWlsLT5zZXRDb250ZXh0KG5ldyBNTV9Db250ZXh0KCkpOw0KCQkJJGVtYWlsLT5zZXRTdWJqZWN0KCJNZW1iZXJNb3VzZSBkZWFjdGl2YXRlZCBvbiAiLmdldF9vcHRpb24oJ3NpdGV1cmwnKSk7DQoJCQkkZW1haWwtPnNldEZyb21OYW1lKCJNZW1iZXJNb3VzZSBOb3RpZmljYXRpb24iKTsNCgkJCSRlbWFpbC0+c2V0RnJvbUFkZHJlc3MoImRvLW5vdC1yZXBseUBtZW1iZXJtb3VzZS5jb20iKTsKCQkJJGVtYWlsLT5hZGRDQygic3VwcG9ydEBtZW1iZXJtb3VzZS5jb20iLCAiTWVtYmVyTW91c2UgU3VwcG9ydCIpOw0KCQkJJGVtYWlsLT5zZXRUb05hbWUoJGVtcGxveWVlLT5nZXRGaXJzdE5hbWUoKSk7DQoJCQkkZW1haWwtPnNldFRvQWRkcmVzcygkZW1wbG95ZWUtPmdldEVtYWlsKCkpOwoJCQkKCQkJJGJvZHkgPSAiTWVtYmVyTW91c2UgaGFzIGJlZW4gZGVhY3RpdmF0ZWQgb24gIi5nZXRfb3B0aW9uKCdzaXRldXJsJykuIi5cblxuVGhpcyBpcyBtb3N0IGxpa2VseSBiZWNhdXNlIHlvdXIgTWVtYmVyTW91c2UgbGljZW5zZSBoYXMgZXhwaXJlZC5cblxuIjsKCQkJJGJvZHkgLj0gIklmIHlvdSB0aGluayB0aGlzIHdhcyBkb25lIGluIGVycm9yLCBwbGVhc2UgY29udGFjdCB1cyBhdCBzdXBwb3J0QG1lbWJlcm1vdXNlLmNvbS5cblxuVGhhbmsgeW91LFxuTWVtYmVyTW91c2UgU3VwcG9ydCBUZWFtIjsNCgkJCSRlbWFpbC0+c2V0Qm9keSgkYm9keSk7DQoJCQkKCQkJJGVtYWlsLT5zZW5kKCk7CgkJCQ0KCQkJc2VsZjo6ZGVhY3RpdmF0ZVBsdWdpbigpOw0KCQl9DQoJfQoJCgkKCS8qKiBMSUNFTlNFIEhFTFBFUiBNRVRIT0RTICoqLwoJLyoqCgkgKiBUaGUgZm9sbG93aW5nIG1ldGhvZHMgYXJlIGFzc29jaWF0ZWQgd2l0aCBhbmQgY2FsbGVkIGZyb20gdGhlIE1NX0xpY2Vuc2UgY2xhc3MuIFRoZXkncmUgcHV0IGhlcmUgdG8gZW5zdXJlCgkgKiB0aGUgaGlnaGVzdCBsZXZlbCBvZiBzZWN1cml0eSBob3dldmVyIHRoZSBhcHBsaWNhdGlvbiBzaG91bGRuJ3QgaW50ZXJhY3Qgd2l0aCB0aGVtIGRpcmVjdGx5IG9uIHRoaXMgY2xhc3MsCgkgKiB0aGV5IHNob3VsZCB1c2UgTU1fTGljZW5zZSBhcyB0aGUgbWFpbiBvYmplY3QgdG8gaW50ZXJmYWN0IHdpdGguCgkgKi8KCXB1YmxpYyBzdGF0aWMgZnVuY3Rpb24gZ2V0TGljZW5zZShNTV9MaWNlbnNlICRsaWNlbnNlKQoJewoJCWlmKE1NX01lbWJlck1vdXNlU2VydmljZTo6ZG9BdXRob3JpemUoKSAmJiAhTU1fTWVtYmVyTW91c2VTZXJ2aWNlOjphdXRob3JpemUoZmFsc2UpKQoJCXsKCQkJTU1fTWVtYmVyTW91c2VTZXJ2aWNlOjppbml0aWF0ZVBsdWdpbkRlYWN0aXZhdGlvbigpOwoJCX0NCgkJZWxzZQ0KCQl7CQoJCQkvLyBpZiBsaWNlbnNlIGRhdGEgaXNuJ3QgaW4gc2Vzc2lvbiBvciBuZWVkcyB0byBiZSByZWZyZXNoZWQsIGdldCBpdCBmcm9tIHRoZSBkYXRhYmFzZSAKCQkJLy8gYW5kIHN0b3JlIGl0IGluIHRoZSBzZXNzaW9uCgkJCWlmKCFNTV9TZXNzaW9uOjp2YWx1ZShNTV9TZXNzaW9uOjokS0VZX01NX0xJQ0VOU0UpIHx8IAoJCQkJCU1NX09wdGlvblV0aWxzOjpnZXRPcHRpb24oTU1fT3B0aW9uVXRpbHM6OiRPUFRJT05fS0VZX0xJQ0VOU0VfUkVGUkVTSCkgPT0gIjEiKQoJCQl7CgkJCQkkbGljZW5zZURhdGEgPSBNTV9PcHRpb25VdGlsczo6Z2V0T3B0aW9uKE1NX09wdGlvblV0aWxzOjokT1BUSU9OX0tFWV9MSUNFTlNFX0RBVEEpOwoJCQkJTU1fT3B0aW9uVXRpbHM6OnNldE9wdGlvbihNTV9PcHRpb25VdGlsczo6JE9QVElPTl9LRVlfTElDRU5TRV9SRUZSRVNILCAiMCIpOwoJCQkJTU1fU2Vzc2lvbjo6dmFsdWUoTU1fU2Vzc2lvbjo6JEtFWV9NTV9MSUNFTlNFLCAkbGljZW5zZURhdGEpOwoJCQl9CgkJCWVsc2UKCQkJewoJCQkJJGxpY2Vuc2VEYXRhID0gTU1fU2Vzc2lvbjo6dmFsdWUoTU1fU2Vzc2lvbjo6JEtFWV9NTV9MSUNFTlNFKTsKCQkJfQ0KCQkNCgkJCWlmKCRsaWNlbnNlRGF0YSkNCgkJCXsJCgkJCQkvLyBkZWNyeXB0IGxpY2Vuc2UgZGF0YQoJCQkJJGxpY2Vuc2VEYXRhID0gdW5zZXJpYWxpemUoYmFzZTY0X2RlY29kZSgkbGljZW5zZURhdGEpKTsKCQkJCQoJCQkJJGxpY2Vuc2UtPnNldElkKCRsaWNlbnNlRGF0YS0+aWQpOw0KCQkJCSRsaWNlbnNlLT5zZXRNZW1iZXJJZCgkbGljZW5zZURhdGEtPm1lbWJlcklkKTsNCgkJCQkkbGljZW5zZS0+c2V0TmFtZSgkbGljZW5zZURhdGEtPm5hbWUpOw0KCQkJCSRsaWNlbnNlLT5zZXRVcmwoJGxpY2Vuc2VEYXRhLT51cmwpOw0KCQkJCSRsaWNlbnNlLT5zZXRBcGlLZXkoJGxpY2Vuc2VEYXRhLT5hcGlLZXkpOw0KCQkJCSRsaWNlbnNlLT5zZXRBcGlTZWNyZXQoJGxpY2Vuc2VEYXRhLT5hcGlTZWNyZXQpOw0KCQkJCSRsaWNlbnNlLT5zZXRNYWpvclZlcnNpb24oJGxpY2Vuc2VEYXRhLT5tYWpvclZlcnNpb24pOw0KCQkJCSRsaWNlbnNlLT5zZXRNaW5vclZlcnNpb24oJGxpY2Vuc2VEYXRhLT5taW5vclZlcnNpb24pOw0KCQkJCSRsaWNlbnNlLT5zZXRQZXJtaXNzaW9uc1Byb2ZpbGVJZCgkbGljZW5zZURhdGEtPnBlcm1pc3Npb25zUHJvZmlsZUlkKTsNCgkJCQkkbGljZW5zZS0+c2V0UGVybWlzc2lvbnMoJGxpY2Vuc2VEYXRhLT5wZXJtaXNzaW9ucyk7DQoJCQkJJGxpY2Vuc2UtPnNldFN0YXR1cygkbGljZW5zZURhdGEtPnN0YXR1cyk7DQoJCQkJJGxpY2Vuc2UtPnNldExhc3RVcGRhdGVkKCRsaWNlbnNlRGF0YS0+bGFzdFVwZGF0ZWQpOw0KCQkJCSRsaWNlbnNlLT5zZXREYXRlQWRkZWQoJGxpY2Vuc2VEYXRhLT5kYXRlQWRkZWQpOw0KCQkJCSRsaWNlbnNlLT5zZXRBdXRoS2V5KGJhc2U2NF9lbmNvZGUoZ2V0X29wdGlvbigic2l0ZXVybCIpKSk7DQoJCQkJJGxpY2Vuc2UtPnZhbGlkYXRlKCk7DQoJCQl9DQoJCQllbHNlIGlmKE1NX1V0aWxzOjppc01lbWJlck1vdXNlQWN0aXZlKCkpDQoJCQl7DQoJCQkJTU1fTWVtYmVyTW91c2VTZXJ2aWNlOjppbml0aWF0ZVBsdWdpbkRlYWN0aXZhdGlvbigpOw0KCQkJfQ0KCQl9Cgl9CgkKCXB1YmxpYyBzdGF0aWMgZnVuY3Rpb24gc3RvcmVMaWNlbnNlKE1NX0xpY2Vuc2UgJGxpY2Vuc2UpCgl7CgkJJGxpY2Vuc2VEYXRhID0gYmFzZTY0X2VuY29kZShzZXJpYWxpemUoc2VsZjo6cGFja2FnZVVwTGljZW5zZURhdGEoJGxpY2Vuc2UpKSk7CgkJTU1fT3B0aW9uVXRpbHM6OnNldE9wdGlvbihNTV9PcHRpb25VdGlsczo6JE9QVElPTl9LRVlfTElDRU5TRV9SRUZSRVNILCAiMSIpOwoJCU1NX09wdGlvblV0aWxzOjpzZXRPcHRpb24oTU1fT3B0aW9uVXRpbHM6OiRPUFRJT05fS0VZX0xJQ0VOU0VfREFUQSwgJGxpY2Vuc2VEYXRhKTsKCX0KCQoJcHVibGljIHN0YXRpYyBmdW5jdGlvbiB2YWxpZGF0ZUxpY2Vuc2UoTU1fTGljZW5zZSAkbGljZW5zZSkKCXsKCQkkYXV0aEtleSA9IGJhc2U2NF9kZWNvZGUoJGxpY2Vuc2UtPmdldEF1dGhLZXkoKSk7CgkJCgkJaWYoZW1wdHkoJGF1dGhLZXkpIHx8ICRhdXRoS2V5ICE9IGdldF9vcHRpb24oInNpdGV1cmwiKSkKCQl7CgkJCXNlbGY6OmluaXRpYXRlUGx1Z2luRGVhY3RpdmF0aW9uKCk7CgkJCXJldHVybiBmYWxzZTsKCQl9Cgl9CgkKCXByaXZhdGUgc3RhdGljIGZ1bmN0aW9uIHBhY2thZ2VVcExpY2Vuc2VEYXRhKE1NX0xpY2Vuc2UgJGxpY2Vuc2UpCgl7CgkJJGRhdGEgPSBuZXcgc3RkQ2xhc3MoKTsKCQoJCSRkYXRhLT5pZCA9ICRsaWNlbnNlLT5nZXRJZCgpOwoJCSRkYXRhLT5tZW1iZXJJZCA9ICRsaWNlbnNlLT5nZXRNZW1iZXJJZCgpOwoJCSRkYXRhLT5uYW1lID0gJGxpY2Vuc2UtPmdldE5hbWUoKTsKCQkkZGF0YS0+dXJsID0gJGxpY2Vuc2UtPmdldFVybCgpOwoJCSRkYXRhLT5hcGlLZXkgPSAkbGljZW5zZS0+Z2V0QXBpS2V5KCk7CgkJJGRhdGEtPmFwaVNlY3JldCA9ICRsaWNlbnNlLT5nZXRBcGlTZWNyZXQoKTsKCQkkZGF0YS0+bWFqb3JWZXJzaW9uID0gJGxpY2Vuc2UtPmdldE1ham9yVmVyc2lvbigpOwoJCSRkYXRhLT5taW5vclZlcnNpb24gPSAkbGljZW5zZS0+Z2V0TWlub3JWZXJzaW9uKCk7CgkJJGRhdGEtPnBlcm1pc3Npb25zUHJvZmlsZUlkID0gJGxpY2Vuc2UtPmdldHBlcm1pc3Npb25zUHJvZmlsZUlkKCk7CgkJJGRhdGEtPnBlcm1pc3Npb25zID0gJGxpY2Vuc2UtPmdldFBlcm1pc3Npb25zKCk7CgkJJGRhdGEtPnN0YXR1cyA9ICRsaWNlbnNlLT5nZXRTdGF0dXMoKTsKCQkkZGF0YS0+aXNBcmNoaXZlZEZsYWcgPSAkbGljZW5zZS0+aXNBcmNoaXZlZCgpOwoJCSRkYXRhLT5sYXN0VXBkYXRlZCA9ICRsaWNlbnNlLT5nZXRMYXN0VXBkYXRlZCgpOwoJCSRkYXRhLT5kYXRlQWRkZWQgPSAkbGljZW5zZS0+Z2V0RGF0ZUFkZGVkKCk7CgkKCQlyZXR1cm4gJGRhdGE7Cgl9CgkKCQoJLyoqIFBST1RFQ1RFRCBVVElMSVRFUyAqKi8NCglwdWJsaWMgc3RhdGljIGZ1bmN0aW9uIGVuY3J5cHRQYXNzd29yZCgkcGFzc3dvcmQpDQoJew0KCQlmb3IoJGk9MDsgJGk8NTsgJGkrKykNCgkJew0KCQkJJHBhc3N3b3JkID0gc3RycmV2KGJhc2U2NF9lbmNvZGUoJHBhc3N3b3JkKSk7DQoJCX0NCgkJCQ0KCQlyZXR1cm4gJHBhc3N3b3JkOw0KCX0NCg0KCXB1YmxpYyBzdGF0aWMgZnVuY3Rpb24gZGVjcnlwdFBhc3N3b3JkKCRwYXNzd29yZCkNCgl7DQoJCWZvcigkaT0wOyAkaTw1OyAkaSsrKQ0KCQl7DQoJCQkkcGFzc3dvcmQgPSBiYXNlNjRfZGVjb2RlKHN0cnJldigkcGFzc3dvcmQpKTsNCgkJfQ0KDQoJCXJldHVybiAkcGFzc3dvcmQ7DQoJfQp9Cgo=', '1', NOW());";
		if($wpdb->query($addSql) === false)
		{	
			return false;
		}
		return true;
 	}
 	
 	public function authenticateWithMM()
 	{
 		if(class_exists("MM_MemberMouseService"))
 		{
	 		return MM_MemberMouseService::authorize();
 		}
 		return false;
 	}
 	
 	private function alterMMTables()
 	{
 		global $wpdb;
 		
 		//conditionally drop reporting index since dbdelta doesn't properly deal with compound indexes
 		if ($wpdb->get_var("SHOW TABLES LIKE '".MM_TABLE_REPORT_DATA_CACHE."'") == MM_TABLE_REPORT_DATA_CACHE)
 		{
 			$wpdb->query("DELETE FROM ".MM_TABLE_REPORT_DATA_CACHE);
 			$wpdb->query("ALTER TABLE ".MM_TABLE_REPORT_DATA_CACHE." DROP INDEX mm_report_data_cache_token_hash_idx");
 		}
 		
 		$filename = "install_sql";
 		require_once(MM_PLUGIN_ABSPATH."/data/{$filename}.php");	

		if (isset($sql) && count($sql)>0)
		{
			dbdelta($sql);
		}
		
 		return true;
 	} 	
 	
 	private function hasRecords($table, $column, $where)
 	{
 		global $wpdb;
 		
 		$sql = "select count(*) as total from {$table} where {$column}='".addslashes($where)."'"; 
 		$row = $wpdb->get_row($sql);
 		return ($row->total>0);
 	}
 	
 	
 	private function insertMMDefaultData()
 	{
 		global $wpdb, $current_user;
		
 		// insert default option values
		MM_OptionUtils::setDefaultValue(MM_OptionUtils::$OPTION_KEY_ACCT_SECURITY_ENABLED, MM_OptionUtils::$DEFAULT_ACCT_SECURITY_ENABLED);
		MM_OptionUtils::setDefaultValue(MM_OptionUtils::$OPTION_KEY_ACCT_SECURITY_MAX_IPS, MM_OptionUtils::$DEFAULT_ACCT_SECURITY_MAX_IPS);
		MM_OptionUtils::setDefaultValue(MM_OptionUtils::$OPTION_KEY_ON_LOGIN_USE_WP_FRONTPAGE, MM_OptionUtils::$DEFAULT_ON_LOGIN_USE_WP_FRONTPAGE);
		MM_OptionUtils::setDefaultValue(MM_OptionUtils::$OPTION_KEY_AFTER_LOGIN_USE_WP_FRONTPAGE, MM_OptionUtils::$DEFAULT_AFTER_LOGIN_USE_WP_FRONTPAGE);
		MM_OptionUtils::setDefaultValue(MM_OptionUtils::$OPTION_KEY_SHOW_LOGIN_LOGOUT_LINK, MM_OptionUtils::$DEFAULT_SHOW_LOGIN_LOGOUT_LINK);
		MM_OptionUtils::setDefaultValue(MM_OptionUtils::$OPTION_KEY_HIDE_PROTECTED_MENU_ITEMS, MM_OptionUtils::$DEFAULT_HIDE_PROTECTED_MENU_ITEMS);
		MM_OptionUtils::setDefaultValue(MM_OptionUtils::$OPTION_KEY_COUNTRY_SELECTIONS, MM_OptionUtils::$DEFAULT_COUNTRY_SELECTIONS);
		MM_OptionUtils::setDefaultValue(MM_OptionUtils::$OPTION_KEY_FORGOT_PASSWORD_SUBJECT, MM_OptionUtils::$DEFAULT_FORGOT_PASSWORD_SUBJECT);
		MM_OptionUtils::setDefaultValue(MM_OptionUtils::$OPTION_KEY_FORGOT_PASSWORD_BODY, MM_OptionUtils::$DEFAULT_FORGOT_PASSWORD_BODY);
		MM_OptionUtils::setDefaultValue(MM_OptionUtils::$OPTION_KEY_AFFILIATE, MM_OptionUtils::$DEFAULT_AFFILIATE);
		MM_OptionUtils::setDefaultValue(MM_OptionUtils::$OPTION_KEY_SUB_AFFILIATE, MM_OptionUtils::$DEFAULT_SUB_AFFILIATE);
		MM_OptionUtils::setDefaultValue(MM_OptionUtils::$OPTION_KEY_AFFILIATE_LIFESPAN, MM_OptionUtils::$DEFAULT_AFFILIATE_LIFESPAN);
		MM_OptionUtils::setDefaultValue(MM_OptionUtils::$OPTION_KEY_LOGIN_TOKEN_LIFESPAN, MM_OptionUtils::$DEFAULT_LOGIN_TOKEN_LIFESPAN);
		MM_OptionUtils::setDefaultValue(MM_OptionUtils::$OPTION_KEY_USE_CHECKOUT_FORM_TEST_DATA, MM_OptionUtils::$DEFAULT_USE_CHECKOUT_FORM_TEST_DATA);
		MM_OptionUtils::setDefaultValue(MM_OptionUtils::$OPTION_KEY_PURCHASE_CONFIRMATION_DIALOG_WIDTH, MM_OptionUtils::$DEFAULT_PURCHASE_CONFIRMATION_DIALOG_WIDTH);
		MM_OptionUtils::setDefaultValue(MM_OptionUtils::$OPTION_KEY_PURCHASE_CONFIRMATION_DIALOG_HEIGHT, MM_OptionUtils::$DEFAULT_PURCHASE_CONFIRMATION_DIALOG_HEIGHT);
		MM_OptionUtils::setDefaultValue(MM_OptionUtils::$OPTION_KEY_DEFAULT_CHECKOUT_ITEM_TYPE, MM_OptionUtils::$DEFAULT_CHECKOUT_ITEM_TYPE);
		MM_OptionUtils::setDefaultValue(MM_OptionUtils::$OPTION_KEY_DEFAULT_CHECKOUT_ITEM_ID, MM_OptionUtils::$DEFAULT_CHECKOUT_ITEM_ID);
		MM_OptionUtils::setDefaultValue(MM_OptionUtils::$OPTION_KEY_SHOW_PREVIEW_BAR, MM_OptionUtils::$DEFAULT_SHOW_PREVIEW_BAR);
		MM_OptionUtils::setDefaultValue(MM_OptionUtils::$OPTION_KEY_HIDE_ADMIN_BAR, MM_OptionUtils::$DEFAULT_HIDE_ADMIN_BAR);
		MM_OptionUtils::setDefaultValue(MM_OptionUtils::$OPTION_KEY_ENABLE_USERNAME_CHANGE, MM_OptionUtils::$DEFAULT_ENABLE_USERNAME_CHANGE);
		MM_OptionUtils::setDefaultValue(MM_OptionUtils::$OPTION_KEY_ALLOW_LOGGED_OUT_PURCHASES, MM_OptionUtils::$DEFAULT_ALLOW_LOGGED_OUT_PURCHASES);
		MM_OptionUtils::setDefaultValue(MM_OptionUtils::$OPTION_KEY_ALLOW_DUPLICATE_SUBSCRIPTIONS, MM_OptionUtils::$DEFAULT_ALLOW_DUPLICATE_SUBSCRIPTIONS);
		MM_OptionUtils::setDefaultValue(MM_OptionUtils::$OPTION_KEY_CHECKOUT_PAID_MESSAGE, MM_OptionUtils::$DEFAULT_CHECKOUT_PAID_MESSAGE);
		MM_OptionUtils::setDefaultValue(MM_OptionUtils::$OPTION_KEY_CHECKOUT_FREE_MESSAGE, MM_OptionUtils::$DEFAULT_CHECKOUT_FREE_MESSAGE);
		MM_OptionUtils::setDefaultValue(MM_OptionUtils::$OPTION_KEY_CHECKOUT_MESSAGE_CSS, MM_OptionUtils::$DEFAULT_CHECKOUT_MESSAGE_CSS);
		MM_OptionUtils::setDefaultValue(MM_OptionUtils::$OPTION_KEY_CURRENCY, MM_OptionUtils::$DEFAULT_CURRENCY);
		MM_OptionUtils::setDefaultValue(MM_OptionUtils::$OPTION_KEY_USE_JQUERY_UI, MM_OptionUtils::$DEFAULT_USE_JQUERY_UI);
		MM_OptionUtils::setDefaultValue(MM_OptionUtils::$OPTION_KEY_ALLOW_OVERDUE_ACCESS, MM_OptionUtils::$DEFAULT_ALLOW_OVERDUE_ACCESS);
		
		// options that vary based on if this is an upgrade versus a new install
		$lastMajorVersion = MM_OptionUtils::getOption(MM_OptionUtils::$OPTION_KEY_MAJOR_VERSION);
		
		if(empty($lastMajorVersion))
		{
			// set options for new installs
			// for 2.0.7 release
			MM_OptionUtils::setDefaultValue(MM_OptionUtils::$OPTION_KEY_DISABLE_EXPLICIT_LINKS, MM_OptionUtils::$DEFAULT_DISABLE_EXPLICIT_LINKS);
			MM_OptionUtils::setDefaultValue(MM_OptionUtils::$OPTION_KEY_PURCHASE_LINK_STYLE, MM_OptionUtils::$DEFAULT_PURCHASE_LINK_STYLE);
			
			// for 2.0.8 release
			MM_OptionUtils::setDefaultValue(MM_OptionUtils::$OPTION_KEY_SMARTTAG_VERSION, MM_OptionUtils::$DEFAULT_SMARTTAG_VERSION);
			
			// for 2.0.9 release
			MM_OptionUtils::setDefaultValue(MM_OptionUtils::$OPTION_KEY_ACTIVITY_LOG_CLEANUP_ENABLED, MM_OptionUtils::$DEFAULT_ACTIVITY_LOG_CLEANUP_ENABLED);
			MM_OptionUtils::setDefaultValue(MM_OptionUtils::$OPTION_KEY_ACTIVITY_LOG_CLEANUP_INTERVAL, MM_OptionUtils::$DEFAULT_ACTIVITY_LOG_CLEANUP_INTERVAL);
			
			// for 2.1.2 release
			MM_OptionUtils::setDefaultValue(MM_OptionUtils::$OPTION_KEY_USE_MM_CSS_CHECKOUT, MM_OptionUtils::$DEFAULT_USE_MM_CSS);
			MM_OptionUtils::setDefaultValue(MM_OptionUtils::$OPTION_KEY_USE_MM_CSS_MY_ACCOUNT, MM_OptionUtils::$DEFAULT_USE_MM_CSS);
			MM_OptionUtils::setDefaultValue(MM_OptionUtils::$OPTION_KEY_USE_MM_CSS_LOGIN, MM_OptionUtils::$DEFAULT_USE_MM_CSS);
			MM_OptionUtils::setDefaultValue(MM_OptionUtils::$OPTION_KEY_USE_MM_CSS_FORGOT_PASSWORD, MM_OptionUtils::$DEFAULT_USE_MM_CSS);
			MM_OptionUtils::setDefaultValue(MM_OptionUtils::$OPTION_KEY_ENABLE_MEMBERSHIP_PRORATION, MM_OptionUtils::$DEFAULT_ENABLE_MEMBERSHIP_PRORATION);
		}
		else
		{
			// set options for existing installs
			// for 2.0.7 release
			MM_OptionUtils::setDefaultValue(MM_OptionUtils::$OPTION_KEY_DISABLE_EXPLICIT_LINKS, "0");
			MM_OptionUtils::setDefaultValue(MM_OptionUtils::$OPTION_KEY_PURCHASE_LINK_STYLE, MM_LINK_STYLE_EXPLICIT);
			
			// for 2.0.8 release
			MM_OptionUtils::setDefaultValue(MM_OptionUtils::$OPTION_KEY_SMARTTAG_VERSION, "2.0");
			
			// for 2.0.9 release
			MM_OptionUtils::setDefaultValue(MM_OptionUtils::$OPTION_KEY_ACTIVITY_LOG_CLEANUP_ENABLED, "0");
			MM_OptionUtils::setDefaultValue(MM_OptionUtils::$OPTION_KEY_ACTIVITY_LOG_CLEANUP_INTERVAL, "");

			// for 2.1.2 release
			MM_OptionUtils::setDefaultValue(MM_OptionUtils::$OPTION_KEY_USE_MM_CSS_CHECKOUT, "0");
			MM_OptionUtils::setDefaultValue(MM_OptionUtils::$OPTION_KEY_USE_MM_CSS_MY_ACCOUNT, "0");
			MM_OptionUtils::setDefaultValue(MM_OptionUtils::$OPTION_KEY_USE_MM_CSS_LOGIN, "0");
			MM_OptionUtils::setDefaultValue(MM_OptionUtils::$OPTION_KEY_USE_MM_CSS_FORGOT_PASSWORD, "0");
			MM_OptionUtils::setDefaultValue(MM_OptionUtils::$OPTION_KEY_ENABLE_MEMBERSHIP_PRORATION, "0");
		}
 		
 		MM_Role::addRoles();
 		
	 	// create default employee account if one doesn't exist, using the current user
	 	$install_sql = "select * from ".MM_TABLE_EMPLOYEE_ACCOUNTS." where is_default='1' LIMIT 1;";
	 	$row = $wpdb->get_row($install_sql);
	 	if($row == null)
	 	{
	 		//the current user isn't an employee
	 		$install_sql = "insert into ".MM_TABLE_EMPLOYEE_ACCOUNTS." set display_name='%s', email='%s', is_default='%d', role_id='%s', user_id='%d'";
	 		$displayName = (!empty($current_user->display_name)) ? $current_user->display_name : "Support";
	 		$wpdb->query($wpdb->prepare($install_sql, $displayName, $current_user->user_email, 1, MM_Role::$ROLE_ADMINISTRATOR, $current_user->ID));
	 		$emailId = $wpdb->insert_id;
	 	}
	 	else 
	 	{
	 		$emailId = $row->id;
	 	}
	 	
	 	// install default overdue payment notification email
	 	$crntValue = MM_OptionUtils::getOption(MM_OptionUtils::$OPTION_KEY_OVERDUE_PAYMENT_NOTIFICATION_INSTALLED);
	 	if($crntValue === false || $crntValue === "")
	 	{
	 		$action = new MM_Action();
	 		$action->setEventType(MM_Event::$MEMBER_STATUS_CHANGE);
	 		$action->setActionType(MM_Action::$MM_ACTION_SEND_EMAIL);
	 			
	 		$emailToId = MM_Action::$CURRENT_MEMBER_PLACEHOLDER;
	 		$emailFromId = $emailId;
	 		$emailCC = "";
	 		$emailSubject = MM_OptionUtils::$DEFAULT_OVERDUE_PAYMENT_SUBJECT;
	 		$emailBody = MM_OptionUtils::$DEFAULT_OVERDUE_PAYMENT_BODY;
	 		$action->setActionValue(MM_Action::prepareSendEmailValue($emailToId, $emailFromId, $emailCC, $emailSubject, $emailBody));
	 			
	 		// set attributes
	 		$attributes = array();
	 		$attributes["status_id"] = MM_Status::$OVERDUE;
	 		$action->setEventAttributes($attributes);
	 		
	 		$result = $action->commitData();
	 		
	 		if(MM_Response::isSuccess($result))
	 		{
	 			MM_OptionUtils::setOption(MM_OptionUtils::$OPTION_KEY_OVERDUE_PAYMENT_NOTIFICATION_INSTALLED, "1");
	 		}
	 	}
	 	
 		// create default membership level
	 	if(!$this->hasRecords(MM_TABLE_MEMBERSHIP_LEVELS, 'is_default', '1'))
	 	{
		 	$install_sql = "INSERT INTO ".MM_TABLE_MEMBERSHIP_LEVELS." SET " .
			 			"	name = 'Free Membership'," .
			 			"	is_free='1'," .
			 			"	is_default='1'," .
			 			"	status='1'," .
			 			"	description='Default Free Membership'," .
			 			"	email_subject='%s'," .
			 			"	email_body='%s'," .
			 			"	email_from_id='%d'" .
			 			"";
		 	
		 	$wpdb->query($wpdb->prepare($install_sql, MM_MembershipLevel::$DFLT_EMAIL_SUBJECT, MM_MembershipLevel::$DFLT_EMAIL_BODY, $emailId));
	 	}
	 	
	 	// create default commission profile
	 	if(!$this->hasRecords(MM_TABLE_COMMISSION_PROFILES, 'is_default', '1'))
	 	{
	 		$install_sql = "INSERT INTO ".MM_TABLE_COMMISSION_PROFILES." SET " .
	 				"	name = 'Standard Commission Profile'," .
		 			"	is_default='1'," .
		 			"	description='This is the default commission profile'," .
		 			"	initial_commission_enabled='1'," .
		 			"	rebill_commissions_enabled='0'," .
		 			"	rebill_commission_type='default'," .
		 			"	rebill_commission_value='0'," .
		 			"	do_limit_rebill_commissions='0'," .
		 			"	rebill_commission_limit='0', " .
		 			"	do_reverse_commissions='1'" .
	 				"";
	 	
	 		$wpdb->query($install_sql);
	 	}
 		
 		// make sure active ayment services are updated
 		if(class_exists('MM_PaymentServiceFactory') && class_exists('MM_PaymentService'))
 		{
	 		$services = MM_PaymentServiceFactory::getAvailablePaymentServices();
	 			
	 		foreach ($services as $service)
	 		{
	 			if ($service instanceof MM_PaymentService)
	 			{
	 				$service->install();
	 			}
	 		}
 		}
 		
 		//add smart tags
	 	$this->addSmartTags();
	 	
	 	$sql = "select count(*) as total from ".MM_TABLE_API_KEYS;
	 	$row = $wpdb->get_row($sql);
	 	
	 	if($row->total<=0)
	 	{
	 		$sql = "insert into ".MM_TABLE_API_KEYS." set ".
		 		   "name='Default Access', ".
		 		   "api_key='".MM_Utils::createRandomString(10)."',	".
		 		   "api_secret='".MM_Utils::createRandomString(10)."', ".
		 		   "status='1'";
	 		
		 	$wpdb->query($sql);
	 	}
	 	
	 	$sql = array();
	 	require_once(MM_PLUGIN_ABSPATH."/data/countries.sql.php");
	 	$numCountries = count($sql);
	 	$countryCheckSql = "select count(*) as total from ".MM_TABLE_COUNTRIES;
	 	$row = $wpdb->get_row($countryCheckSql);
	 	if ($row->total < $numCountries)
	 	{
	 		foreach ($sql as $query)
	 		{
	 			if($wpdb->query($query) === false)
	 			{
	 				return false;
	 			}
	 		}
	 	}
	 	unset($sql);
	 	
	 	$result = $this->setupCorePages();
	 	
	 	if(!$result)
	 	{
	 		return false;
	 	}
	 	
	 	$cacheWriteable = @MM_Utils::cacheIsWriteable();
	 		
	 	$sql = array();
	 		
	 	//TODO TRANSIENT: in version 2.0.1 renamed WordPress Mail to None. Once all customers have been upgraded to None then this 
	 	// if statement can be removed
	 	if($this->hasRecords(MM_TABLE_EMAIL_SERVICE_PROVIDERS, 'provider_token', 'default'))
	 	{
	 		$sql[] = "UPDATE ".MM_TABLE_EMAIL_SERVICE_PROVIDERS." SET provider_name='None' WHERE provider_token='default';";
	 	}
	 	else 
	 	{
	 		$sql[] = "INSERT IGNORE INTO ".MM_TABLE_EMAIL_SERVICE_PROVIDERS." SET provider_name='None', provider_token='default', active='1';";
	 	}
	 	
	 	//email service providers
	 	$sql[] = "INSERT IGNORE INTO ".MM_TABLE_EMAIL_SERVICE_PROVIDERS." SET provider_name='MailChimp', provider_token='mailchimp', active='0';";
	 	$sql[] = "INSERT IGNORE INTO ".MM_TABLE_EMAIL_SERVICE_PROVIDERS." SET provider_name='iContact', provider_token='icontact', api_key='".MM_IContactEmailServiceProvider::$API_KEY."'";
	 	$sql[] = "INSERT IGNORE INTO ".MM_TABLE_EMAIL_SERVICE_PROVIDERS." SET provider_name='AWeber', provider_token='aweber', active='0';";
	 	$sql[] = "INSERT IGNORE INTO ".MM_TABLE_EMAIL_SERVICE_PROVIDERS." SET provider_name='GetResponse', provider_token='getresponse', active='0';";
	 	
	 	//affiliate providers
	 	$sql[] = "INSERT IGNORE INTO ".MM_TABLE_AFFILIATE_PROVIDERS." SET provider_name='None', provider_token='default', active='1';";
	 	$sql[] = "INSERT IGNORE INTO ".MM_TABLE_AFFILIATE_PROVIDERS." SET provider_name='iDevAffiliate', provider_token='idevaffiliate';";
	 		
	 	//payment services
	 	$sql[] = "INSERT IGNORE INTO ".MM_TABLE_PAYMENT_SERVICES." SET token='PAYPAL', name='PayPal', settings='', active='0';";
	 	$sql[] = "INSERT IGNORE INTO ".MM_TABLE_PAYMENT_SERVICES." SET token='AUTHORIZENET', name='Authorize.net', settings='', active='0';";
	 	$sql[] = "INSERT IGNORE INTO ".MM_TABLE_PAYMENT_SERVICES." SET token='AUTHORIZENETCIM', name='Authorize.net CIM', settings='', active='0';";
	 	$sql[] = "INSERT IGNORE INTO ".MM_TABLE_PAYMENT_SERVICES." SET token='BRAINTREE', name='Braintree', settings='', active='0';";
	 	$sql[] = "INSERT IGNORE INTO ".MM_TABLE_PAYMENT_SERVICES." SET token='CHARGIFY', name='Chargify', settings='', active='0';";
	 	$sql[] = "INSERT IGNORE INTO ".MM_TABLE_PAYMENT_SERVICES." SET token='LIMELIGHT', name='Lime Light', settings='', active='0';";
	 	$sql[] = "INSERT IGNORE INTO ".MM_TABLE_PAYMENT_SERVICES." SET token='STRIPE', name='Stripe', settings='', active='0';";
	 	$sql[] = "INSERT IGNORE INTO ".MM_TABLE_PAYMENT_SERVICES." SET token='CLICKBANK', name='ClickBank', settings='', active='0';";
	 	$sql[] = "INSERT IGNORE INTO ".MM_TABLE_PAYMENT_SERVICES." SET token='LITLE', name='Litle', settings='', active='0';";
	 	$sql[] = "INSERT IGNORE INTO ".MM_TABLE_PAYMENT_SERVICES." SET token='COINBASE', name='Coinbase (Wallet Required)', settings='', active='0';";
	 	$sql[] = "INSERT IGNORE INTO ".MM_TABLE_PAYMENT_SERVICES." SET token='COINBASEMINIMAL', name='Coinbase (Wallet Ignored)', settings='', active='0';";
	 	
	 	//shipping methods
	 	$sql[] = "INSERT IGNORE INTO ".MM_TABLE_SHIPPING_METHODS." SET token='FLATRATE', name='Flat Rate', settings='', active='1';"; //active by default
	 	
	 	foreach ($sql as $query)
	 	{
	 		$wpdb->query($query);
	 	}
	 	unset($sql);
	 	
	 	//apply any updates that may have been made to the schemas of the active payment services
	 	$activePaymentServices = MM_PaymentServiceFactory::getAvailablePaymentServices();
	 	foreach ($activePaymentServices as $ps)
	 	{
	 		$ps->install();
	 	}
	 	
	 	return true;
 	}
 	
 	
 	private function setupCorePages()
 	{
 		global $wpdb, $current_user;
 		
 		// Core Page Types
	 	$sql[] = "INSERT IGNORE INTO ".MM_TABLE_CORE_PAGE_TYPES." (id, name, visible) VALUES ('".MM_CorePageType::$MEMBER_HOME_PAGE."','Member Home','1');";
	 	$sql[] = "INSERT IGNORE INTO ".MM_TABLE_CORE_PAGE_TYPES." (id, name, visible) VALUES ('".MM_CorePageType::$SAVETHESALE."','Save the Sale','1');";
 		$sql[] = "INSERT IGNORE INTO ".MM_TABLE_CORE_PAGE_TYPES." (id, name, visible) VALUES ('".MM_CorePageType::$ERROR."','Error','1');";
 		$sql[] = "INSERT IGNORE INTO ".MM_TABLE_CORE_PAGE_TYPES." (id, name, visible) VALUES ('".MM_CorePageType::$LOGIN_PAGE."','Login','1');";
 		$sql[] = "INSERT IGNORE INTO ".MM_TABLE_CORE_PAGE_TYPES." (id, name, visible) VALUES ('".MM_CorePageType::$FORGOT_PASSWORD."','Forgot Password','1');";
 		$sql[] = "INSERT IGNORE INTO ".MM_TABLE_CORE_PAGE_TYPES." (id, name, visible) VALUES ('".MM_CorePageType::$CHECKOUT."','Checkout','1');";
 		$sql[] = "INSERT IGNORE INTO ".MM_TABLE_CORE_PAGE_TYPES." (id, name, visible) VALUES ('".MM_CorePageType::$REDEEM_GIFT."','Redeem Gift','1');";
 		$sql[] = "INSERT IGNORE INTO ".MM_TABLE_CORE_PAGE_TYPES." (id, name, visible) VALUES ('".MM_CorePageType::$PAID_CONFIRMATION."','Confirmation','1');";
 		$sql[] = "INSERT IGNORE INTO ".MM_TABLE_CORE_PAGE_TYPES." (id, name, visible) VALUES ('".MM_CorePageType::$FREE_CONFIRMATION."','Free Confirmation','0');";
 		$sql[] = "INSERT IGNORE INTO ".MM_TABLE_CORE_PAGE_TYPES." (id, name, visible) VALUES ('".MM_CorePageType::$MY_ACCOUNT."','My Account','1');";
 		$sql[] = "INSERT IGNORE INTO ".MM_TABLE_CORE_PAGE_TYPES." (id, name, visible) VALUES ('".MM_CorePageType::$LOGOUT_PAGE."','Logout','1');";
 			
	 	// Default Core Pages
 		$sql[] ="INSERT IGNORE INTO ".MM_TABLE_CORE_PAGES." (id, core_page_type_id) VALUES ('1', '".MM_CorePageType::$MEMBER_HOME_PAGE."');";
 		$sql[] ="INSERT IGNORE INTO ".MM_TABLE_CORE_PAGES." (id, core_page_type_id) VALUES ('2', '".MM_CorePageType::$SAVETHESALE."');";
 		$sql[] ="INSERT IGNORE INTO ".MM_TABLE_CORE_PAGES." (id, core_page_type_id) VALUES ('3', '".MM_CorePageType::$ERROR."');";
 		$sql[] ="INSERT IGNORE INTO ".MM_TABLE_CORE_PAGES." (id, core_page_type_id) VALUES ('4', '".MM_CorePageType::$LOGIN_PAGE."');";
 		$sql[] ="INSERT IGNORE INTO ".MM_TABLE_CORE_PAGES." (id, core_page_type_id) VALUES ('5', '".MM_CorePageType::$FORGOT_PASSWORD."');";
 		$sql[] ="INSERT IGNORE INTO ".MM_TABLE_CORE_PAGES." (id, core_page_type_id) VALUES ('6', '".MM_CorePageType::$CHECKOUT."');";
 		$sql[] ="INSERT IGNORE INTO ".MM_TABLE_CORE_PAGES." (id, core_page_type_id) VALUES ('7', '".MM_CorePageType::$PAID_CONFIRMATION."');";
 		$sql[] ="INSERT IGNORE INTO ".MM_TABLE_CORE_PAGES." (id, core_page_type_id) VALUES ('9', '".MM_CorePageType::$FREE_CONFIRMATION."');";
 		$sql[] ="INSERT IGNORE INTO ".MM_TABLE_CORE_PAGES." (id, core_page_type_id) VALUES ('10', '".MM_CorePageType::$MY_ACCOUNT."');";
 		$sql[] ="INSERT IGNORE INTO ".MM_TABLE_CORE_PAGES." (id, core_page_type_id) VALUES ('11', '".MM_CorePageType::$LOGOUT_PAGE."');";
 		$sql[] ="INSERT IGNORE INTO ".MM_TABLE_CORE_PAGES." (id, core_page_type_id) VALUES ('12', '".MM_CorePageType::$REDEEM_GIFT."');";
	 	
	 	foreach($sql as $query)
	 	{
	 		if($wpdb->query($query) === false)
	 		{
	 			echo $query;
	 			return false;
	 		}
	 	}
	 	unset($sql);
 		
	 	// Install Default Core Pages
	 	$templateParams = new stdClass();
	 	$templateParams->resourceDirectory = MM_RESOURCES_URL;
	 	$mm_template_base = MM_PLUGIN_ABSPATH."/templates";
	 	
		// Member Homepage
 		$corePageSql = "select count(*) as total from ".MM_TABLE_CORE_PAGES." where core_page_type_id = '".MM_CorePageType::$MEMBER_HOME_PAGE."' and ref_type IS NULL and page_id IS NULL";
 		$row = $wpdb->get_row($corePageSql);
	 	
	 	if($row->total > 0)
	 	{	
	 		$sql = "insert into {$wpdb->posts} (post_type, post_author, post_date, post_status,post_content, post_title, post_name) " .
	 				"		values ('page',$current_user->ID, NOW(), 'publish','".addslashes(MM_TEMPLATE::generate($mm_template_base."/default_templates/homepage.html.php", $templateParams))."', '[MM_Member_Data name=\"membershipName\"] Home Page', '".$this->getPostName('home')."');";
	 		
 			if(!$wpdb->query($sql))
 			{
 				echo $query;
 				return false;
 			}
 			
 			$this->linkCorePage($wpdb->insert_id, MM_CorePageType::$MEMBER_HOME_PAGE);
	 	}
	 	
	 	// Save-the-Sale Page
	 	$corePageSql = "select count(*) as total from ".MM_TABLE_CORE_PAGES." where core_page_type_id = '".MM_CorePageType::$SAVETHESALE."' and ref_type IS NULL and page_id IS NULL";
	 	$row = $wpdb->get_row($corePageSql);
	 	 
	 	if($row->total > 0)
	 	{
		 	$sql = "insert into {$wpdb->posts} (post_type, post_author, post_date, post_status,post_content, post_title, post_name) " .
		 			"		values ('page',$current_user->ID, NOW(), 'publish','".addslashes(MM_TEMPLATE::generate($mm_template_base."/default_templates/cancel.html.php", $templateParams))."', 'Cancel Membership', '".$this->getPostName('cancel')."');";
		 			
		 	if(!$wpdb->query($sql))
	 		{
	 			echo $query;
	 			return false;
	 		}
	 			
	 		$this->linkCorePage($wpdb->insert_id, MM_CorePageType::$SAVETHESALE);
	 	}
	 	
	 	// Error Page
	 	$corePageSql = "select count(*) as total from ".MM_TABLE_CORE_PAGES." where core_page_type_id = '".MM_CorePageType::$ERROR."' and ref_type IS NULL and page_id IS NULL";
	 	$row = $wpdb->get_row($corePageSql);
	 	
	 	if($row->total > 0)
		{
		 	$sql = "insert into {$wpdb->posts} (post_type, post_author, post_date, post_status,post_content, post_title, post_name) " .
		 			"		values ('page',$current_user->ID, NOW(), 'publish','".addslashes(MM_TEMPLATE::generate($mm_template_base."/default_templates/error.html.php", $templateParams))."', 'Error', '".$this->getPostName('mm-error')."');";
		 			
		 	if(!$wpdb->query($sql))
	 		{
	 			echo $query;
	 			return false;
	 		}
	 			
	 		$this->linkCorePage($wpdb->insert_id, MM_CorePageType::$ERROR);
	 	}
	 	
	 	// Login Page
	 	$corePageSql = "select count(*) as total from ".MM_TABLE_CORE_PAGES." where core_page_type_id = '".MM_CorePageType::$LOGIN_PAGE."' and ref_type IS NULL and page_id IS NULL";
	 	$row = $wpdb->get_row($corePageSql);
	 	 
	 	if($row->total > 0)
	 	{
		 	$sql = "insert into {$wpdb->posts} (post_type, post_author, post_date, post_status,post_content, post_title, post_name) " .
		 			"		values ('page',$current_user->ID, NOW(), 'publish','".addslashes(MM_TEMPLATE::generate($mm_template_base."/default_templates/login.html.php", $templateParams))."', 'Login', '".$this->getPostName('login')."');";
		 		
		 	if(!$wpdb->query($sql))
	 		{
	 			echo $query;
	 			return false;
	 		}
	 			
	 		$this->linkCorePage($wpdb->insert_id, MM_CorePageType::$LOGIN_PAGE);
	 	}

	 	// Logout Page
	 	$corePageSql = "select count(*) as total from ".MM_TABLE_CORE_PAGES." where core_page_type_id = '".MM_CorePageType::$LOGOUT_PAGE."' and ref_type IS NULL and page_id IS NULL";
	 	$row = $wpdb->get_row($corePageSql);
	 	
	 	if($row->total > 0)
	 	{
		 	$sql = "insert into {$wpdb->posts} (post_type, post_author, post_date, post_status,post_content, post_title, post_name) " .
		 			"		values ('page',$current_user->ID, NOW(), 'publish','".addslashes(MM_TEMPLATE::generate($mm_template_base."/default_templates/logout.html.php", $templateParams))."', 'Logout', '".$this->getPostName('logout')."');";
		 			
		 	if(!$wpdb->query($sql))
	 		{
	 			echo $query;
	 			return false;
	 		}
	 			
	 		$this->linkCorePage($wpdb->insert_id, MM_CorePageType::$LOGOUT_PAGE);
	 	}
	 	
	 	// Forgot Password Page
	 	$corePageSql = "select count(*) as total from ".MM_TABLE_CORE_PAGES." where core_page_type_id = '".MM_CorePageType::$FORGOT_PASSWORD."' and ref_type IS NULL and page_id IS NULL";
	 	$row = $wpdb->get_row($corePageSql);
	 	 
	 	if($row->total > 0)
	 	{
		 	$sql = "insert into {$wpdb->posts} (post_type, post_author, post_date, post_status,post_content, post_title, post_name) " .
		 			"		values ('page',$current_user->ID, NOW(), 'publish','".addslashes(MM_TEMPLATE::generate($mm_template_base."/default_templates/forgotpassword.html.php", $templateParams))."', 'Forgot Password', '".$this->getPostName('forgot-password')."');";
		 			
		 	if(!$wpdb->query($sql))
	 		{
	 			echo $query;
	 			return false;
	 		}
	 			
	 		$this->linkCorePage($wpdb->insert_id, MM_CorePageType::$FORGOT_PASSWORD);
	 	}
	 	
	 	// Checkout Page
	 	$corePageSql = "select count(*) as total from ".MM_TABLE_CORE_PAGES." where core_page_type_id = '".MM_CorePageType::$CHECKOUT."' and ref_type IS NULL and page_id IS NULL";
	 	$row = $wpdb->get_row($corePageSql);
	 	
	 	if($row->total > 0)
	 	{
		 	$sql = "insert into {$wpdb->posts} (post_type, post_author, post_date, post_status,post_content, post_title, post_name) " .
		 			"		values ('page',$current_user->ID, NOW(), 'publish','".addslashes(MM_TEMPLATE::generate($mm_template_base."/default_templates/checkout.html.php", $templateParams))."', 'Checkout', '".$this->getPostName('checkout')."');";
		 			
		 	if(!$wpdb->query($sql))
	 		{
	 			echo $query;
	 			return false;
	 		}
	 			
	 		$this->linkCorePage($wpdb->insert_id, MM_CorePageType::$CHECKOUT);
	 	}
	 	
	 	// Redeem Gift Page
	 	$corePageSql = "select count(*) as total from ".MM_TABLE_CORE_PAGES." where core_page_type_id = '".MM_CorePageType::$REDEEM_GIFT."' and ref_type IS NULL and page_id IS NULL";
	 	$row = $wpdb->get_row($corePageSql);
	 	 
	 	if($row->total > 0)
	 	{
	 		$sql = "insert into {$wpdb->posts} (post_type, post_author, post_date, post_status,post_content, post_title, post_name) " .
	 			"		values ('page',$current_user->ID, NOW(), 'publish','".addslashes(MM_TEMPLATE::generate($mm_template_base."/default_templates/redeemgift.html.php", $templateParams))."', 'Redeem Gift', '".$this->getPostName('redeem-gift')."');";
	 				
	 		if(!$wpdb->query($sql))
	 		{
	 			echo $query;
	 			return false;
	 		}
	 			
	 		$this->linkCorePage($wpdb->insert_id, MM_CorePageType::$REDEEM_GIFT);
	 	}
	 	
	 	// My Account Page
	 	$corePageSql = "select count(*) as total from ".MM_TABLE_CORE_PAGES." where core_page_type_id = '".MM_CorePageType::$MY_ACCOUNT."' and ref_type IS NULL and page_id IS NULL";
	 	$row = $wpdb->get_row($corePageSql);
	 	
	 	if($row->total > 0)
	 	{
		 	$sql = "insert into {$wpdb->posts} (post_type, post_author, post_date, post_status,post_content, post_title, post_name) " .
		 			"		values ('page',$current_user->ID, NOW(), 'publish','".addslashes(MM_TEMPLATE::generate($mm_template_base."/default_templates/myaccount.html.php", $templateParams))."', 'My Account', '".$this->getPostName('myaccount')."');";
		 			
		 	if(!$wpdb->query($sql))
	 		{
	 			echo $query;
	 			return false;
	 		}
	 			
	 		$this->linkCorePage($wpdb->insert_id, MM_CorePageType::$MY_ACCOUNT);
	 	}
	 	
	 	// Paid Confirmation Page
	 	$corePageSql = "select count(*) as total from ".MM_TABLE_CORE_PAGES." where core_page_type_id = '".MM_CorePageType::$PAID_CONFIRMATION."' and ref_type IS NULL and page_id IS NULL";
	 	$row = $wpdb->get_row($corePageSql);
	 	 
	 	if($row->total > 0)
	 	{
		 	$sql = "insert into {$wpdb->posts} (post_type, post_author, post_date, post_status,post_content, post_title, post_name) " .
		 			"		values ('page',$current_user->ID, NOW(), 'publish','".addslashes(MM_TEMPLATE::generate($mm_template_base."/default_templates/confirmation.html.php", $templateParams))."', 'Thank You', '".$this->getPostName('confirmation')."');";
		 			
		 	if(!$wpdb->query($sql))
	 		{
	 			echo $query;
	 			return false;
	 		}
	 			
	 		$this->linkCorePage($wpdb->insert_id, MM_CorePageType::$PAID_CONFIRMATION);
	 	}
	 	
 		return true;
 	}
 	
 	private function addSmartTags()
 	{
 		global $wpdb;
 		require_once(MM_PLUGIN_ABSPATH."/data/smarttags.sql.php");
 		if(isset($sql) && is_array($sql))
 		{
 			foreach($sql as $query)
 			{
 				if($wpdb->query($query)===false){ 
 					return false;	
 				}
 			}
 		}
 		return true;
 	}
 	
 	private function getPostName($suggestedName=""){
 		global $wpdb;
 		$sql = "select count(*) as total from {$wpdb->posts} where post_name='".$suggestedName."'";
 		$row = $wpdb->get_row($sql);
 		if($row->total>0){
	 		$sql = "select post_name from {$wpdb->posts} where post_name like '".$suggestedName."-%'";
	 		$rows = $wpdb->get_results($sql);
	 		
	 		$index=1;
	 		while(true){
	 			$newName = $suggestedName."-".$index;
	 			$hasName = false;
	 			foreach($rows as $row){
	 				if($row->post_name == $newName){
	 					$hasName = true;		
	 				}
	 			}
	 			if(!$hasName){
	 				return $newName;
	 			}
	 			$index++;
	 		}
 		}
 		return $suggestedName;
 	}
 	
 	private function linkCorePage($page_id, $id)
 	{
		global $wpdb;
		$sql = "update ".MM_TABLE_CORE_PAGES." set page_id='{$page_id}' where id='{$id}'";
		
		if(!$wpdb->query($sql))
		{
			echo $sql;
			return false;
		}
 	}
 	
	private function field_exists($column, $table)
	{
		global $wpdb;
		$sql = "describe {$table}";
		$rows = $wpdb->get_results($sql);
	
		for($i=0; $i<count($rows); $i++)
		{
			if($column == $rows[$i]->Field)
			{
				return true;
			}
		}
		
		return false;
	}
	
	private function getFieldType($column, $table)
	{
		global $wpdb;
		$sql = "describe {$table}";
		$rows = $wpdb->get_results($sql);
		
		$numRows = count($rows);
		for($i=0; $i<$numRows; $i++)
		{
			if($column == $rows[$i]->Field)
			{
				return $rows[$i]->Type;
			}
		}
		
		return false;
	}
	
	//TODO remove in MM 2.1.3 release
	private function temporaryRestoreOrderItemAccessPatch()
	{
		if (class_exists("MM_OrderItem"))
		{
			global $wpdb;
			
			$productAccessLevels = array();
			$accessSQL = "SELECT membership_id as access_type_id, product_id,'membership' access_type FROM ".MM_TABLE_MEMBERSHIP_LEVEL_PRODUCTS." ".
						 "UNION ALL SELECT bundle_id as access_type_id, product_id, 'bundle' access_type FROM ".MM_TABLE_BUNDLE_PRODUCTS;
			$results = $wpdb->get_results($accessSQL);
			foreach ($results as $res)
			{
				$productAccessLevels[$res->product_id] = $res;
			}
			
			$orphanSQL = "SELECT o.user_id, oi.id, oi.item_id FROM ".MM_TABLE_ORDER_ITEMS." oi LEFT JOIN ".MM_TABLE_ORDERS." o ON (oi.order_id = o.id) ".
					     "LEFT JOIN ".MM_TABLE_ORDER_ITEM_ACCESS." oia ON (oi.id = oia.order_item_id) ".
						 "WHERE (oi.is_recurring = 1) ".
						 "AND (oi.status IN (".MM_OrderItem::$STATUS_RECURRING.",".MM_OrderItem::$STATUS_RECURRING_COMPLETE.",".MM_OrderItem::$STATUS_RECURRING_REBILL_FAILED.")) ".
						 "AND (oia.access_type_id IS NULL)";
			$results = $wpdb->get_results($orphanSQL);
			foreach ($results as $res)
			{
				if (isset($productAccessLevels[$res->item_id]))
				{
					$access = $productAccessLevels[$res->item_id];
					$wpdb->replace(MM_TABLE_ORDER_ITEM_ACCESS,array("order_item_id"=>$res->id, "user_id"=>$res->user_id, "access_type"=>$access->access_type, "access_type_id"=>$access->access_type_id));
				}
			}
		}	
	}
	
	// remove in MM 2.1.5 release
	private function temporaryPendingOverdueSubscriptionPatch()
	{
		if (class_exists("MM_OrderItem"))
		{
			global $wpdb;
			
			$pymtServicesTable = MM_TABLE_PAYMENT_SERVICES;
			$authNetToken = MM_PaymentService::$AUTHORIZENET_SERVICE_TOKEN;
			$authNetPaymentId = $wpdb->get_var("SELECT id from {$pymtServicesTable} where token='{$authNetToken}'");
			
			if(!is_null($authNetPaymentId))
			{
				$ordersTable = MM_TABLE_ORDERS;
				$orderItemsTable = MM_TABLE_ORDER_ITEMS;
				$transactionsTable = MM_TABLE_TRANSACTION_LOG;
				$transTypePayment = MM_TransactionLog::$TRANSACTION_TYPE_PAYMENT;
				$transTypeRecurringPayment = MM_TransactionLog::$TRANSACTION_TYPE_RECURRING_PAYMENT;
				$authNetSubscriptionsTable = MM_TABLE_AUTHNET_ARB_SUBSCRIPTIONS;
				$orderItemStatusRecurring = MM_OrderItem::$STATUS_RECURRING;
				$orderItemTypeProduct = MM_OrderItem::$ORDER_ITEM_TYPE_PRODUCT;
			
				$sql = "SELECT oi.id as order_item_id, oi.order_id, oi.rebill_period, oi.rebill_frequency, o.user_id FROM {$orderItemsTable} oi INNER JOIN {$ordersTable} o ON (oi.order_id = o.id) LEFT JOIN {$authNetSubscriptionsTable} arbs ON ".
						"(oi.id = arbs.order_item_id) WHERE o.payment_id='{$authNetPaymentId}' AND oi.status='{$orderItemStatusRecurring}' AND ".
						"oi.item_type='{$orderItemTypeProduct}' AND oi.is_recurring=1 AND (arbs.x_subscription_id IS NULL)";
				$result = $wpdb->get_results($sql);
			
				foreach($result as $row)
				{
					// check if pending overdue item has already been inserted for this order item
					$pendingOverdueSubscriptions = MM_TABLE_AUTHNET_PENDING_OVERDUE_SUBSCRIPTIONS;
					$pendingOverdueSubscriptionId = $wpdb->get_var("SELECT id from {$pendingOverdueSubscriptions} where order_item_id='{$row->order_item_id}'");
						
					if (is_null($pendingOverdueSubscriptionId))
					{
						// lookup the last transaction associated with the order item
						$sql = "SELECT transaction_date FROM {$transactionsTable} WHERE order_item_id = {$row->order_item_id} AND ";
						$sql .= "transaction_type IN ({$transTypePayment}, {$transTypeRecurringPayment}) ";
						$sql .= "ORDER BY transaction_date DESC LIMIT 1;";
			
						$lastTransaction = $wpdb->get_row($sql);
						if($lastTransaction)
						{
							// set status of order item to pending overdue
							$orderItem = new MM_OrderItem($row->order_item_id);
			
							if($orderItem->isValid())
							{
								$orderItem->setStatus(5); // set to pending overdue status, not using constant as this script is being run in the installer
								// and on first run the constant may not be defined
								$orderItem->commitData();
									
								// calculate overdue date based on last transaction date and length of subscription cycle
								$overdueDate = date('Y-m-d', strtotime($lastTransaction->transaction_date.' +'.$row->rebill_period.' '.$row->rebill_frequency));
									
								$insertData = array( "order_item_id" => $row->order_item_id, "overdue_date" => $overdueDate);
								$wpdb->insert(MM_TABLE_AUTHNET_PENDING_OVERDUE_SUBSCRIPTIONS,$insertData);
							}
						}
					}
				}
			}
		}
	}
	
	// remove in MM 2.1.6 release
	private function populateOriginAffiliateIds()
	{
		global $wpdb;
		
		$crntValue = MM_OptionUtils::getOption(MM_OptionUtils::$OPTION_KEY_ORIGIN_AFFILIATE_MIGRATED);
		if($crntValue == false || $crntValue == "")
		{
			$excludedStatuses = implode(",",array(MM_Status::$ERROR,MM_Status::$PENDING_ACTIVATION));
			$migrationSQL = "UPDATE ".MM_TABLE_USER_DATA." mu INNER JOIN (SELECT mu1.wp_user_id, mu1.became_active, o.affiliate_id, o.sub_affiliate_id ".
							"FROM ".MM_TABLE_USER_DATA." mu1 INNER JOIN  (SELECT user_id, MIN(id) AS min_order_id FROM ".MM_TABLE_ORDERS." GROUP BY user_id) AS FLATTEN ".
							"ON (mu1.wp_user_id = FLATTEN.user_id) INNER JOIN ".MM_TABLE_ORDERS." o ON (FLATTEN.min_order_id = o.id) WHERE (mu1.status NOT IN ({$excludedStatuses}))".
							"AND (((o.affiliate_id IS NOT NULL) AND (o.affiliate_id != '')) OR ((o.sub_affiliate_id IS NOT NULL) AND (o.sub_affiliate_id != '')))) AS Q ".
							"ON (mu.wp_user_id = Q.wp_user_id) set mu.origin_affiliate_id=Q.affiliate_id, mu.origin_subaffiliate_id=Q.sub_affiliate_id";
			if ($wpdb->query($migrationSQL) !== false)
			{
				MM_OptionUtils::setOption(MM_OptionUtils::$OPTION_KEY_ORIGIN_AFFILIATE_MIGRATED, "1");
			}
		}
	}
 }